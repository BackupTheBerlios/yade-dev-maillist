<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [deprecated list] [Yade-dev] [svn] r1735 - in trunk: core extra	extra/clump	extra/spherical-dem-simulator extra/tetra gui/py	gui/qt3	pkg/common/Engine/DeusExMachina	pkg/common/Engine/EngineUnit	pkg/common/Engine/MetaEngine	pkg/common/Engine/StandAloneEngine	pkg/dem/Engine/DeusExMachina	pkg/dem/Engine/StandAloneEngine	pkg/dem/PreProcessor	pkg/fem/Engine/StandAloneEngine	pkg/fem/PreProcessor	pkg/lattice/PreProcessor	pkg/mass-spring/Engine/StandAloneEngine	pkg/mass-spring/PreProcessor	pkg/realtime-rigidbody/Engine/StandAloneEngine	pkg/realtime-rigidbody/PreProcessor	pkg/snow/PreProcessor
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/yade-dev/2009/index.html" >
   <LINK REL="made" HREF="mailto:yade-dev%40lists.berlios.de?Subject=Re%3A%20%5Bdeprecated%20list%5D%20%5BYade-dev%5D%20%5Bsvn%5D%20r1735%20-%20in%20trunk%3A%20core%20extra%0A%09extra/clump%09extra/spherical-dem-simulator%20extra/tetra%20gui/py%0A%09gui/qt3%09pkg/common/Engine/DeusExMachina%0A%09pkg/common/Engine/EngineUnit%09pkg/common/Engine/MetaEngine%0A%09pkg/common/Engine/StandAloneEngine%09pkg/dem/Engine/DeusExMachina%0A%09pkg/dem/Engine/StandAloneEngine%09pkg/dem/PreProcessor%0A%09pkg/fem/Engine/StandAloneEngine%09pkg/fem/PreProcessor%0A%09pkg/lattice/PreProcessor%09pkg/mass-spring/Engine/StandAloneEngine%0A%09pkg/mass-spring/PreProcessor%09pkg/realtime-rigidbody/Engine/StandAloneEngine%09pkg/realtime-rigidbody/PreProcessor%0A%09pkg/snow/PreProcessor&In-Reply-To=%3C200903291034.n2TAYlBB003292%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000894.html">
   <LINK REL="Next"  HREF="000896.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[deprecated list] [Yade-dev] [svn] r1735 - in trunk: core extra	extra/clump	extra/spherical-dem-simulator extra/tetra gui/py	gui/qt3	pkg/common/Engine/DeusExMachina	pkg/common/Engine/EngineUnit	pkg/common/Engine/MetaEngine	pkg/common/Engine/StandAloneEngine	pkg/dem/Engine/DeusExMachina	pkg/dem/Engine/StandAloneEngine	pkg/dem/PreProcessor	pkg/fem/Engine/StandAloneEngine	pkg/fem/PreProcessor	pkg/lattice/PreProcessor	pkg/mass-spring/Engine/StandAloneEngine	pkg/mass-spring/PreProcessor	pkg/realtime-rigidbody/Engine/StandAloneEngine	pkg/realtime-rigidbody/PreProcessor	pkg/snow/PreProcessor</H1>
    <B>eudoxos at BerliOS</B> 
    <A HREF="mailto:yade-dev%40lists.berlios.de?Subject=Re%3A%20%5Bdeprecated%20list%5D%20%5BYade-dev%5D%20%5Bsvn%5D%20r1735%20-%20in%20trunk%3A%20core%20extra%0A%09extra/clump%09extra/spherical-dem-simulator%20extra/tetra%20gui/py%0A%09gui/qt3%09pkg/common/Engine/DeusExMachina%0A%09pkg/common/Engine/EngineUnit%09pkg/common/Engine/MetaEngine%0A%09pkg/common/Engine/StandAloneEngine%09pkg/dem/Engine/DeusExMachina%0A%09pkg/dem/Engine/StandAloneEngine%09pkg/dem/PreProcessor%0A%09pkg/fem/Engine/StandAloneEngine%09pkg/fem/PreProcessor%0A%09pkg/lattice/PreProcessor%09pkg/mass-spring/Engine/StandAloneEngine%0A%09pkg/mass-spring/PreProcessor%09pkg/realtime-rigidbody/Engine/StandAloneEngine%09pkg/realtime-rigidbody/PreProcessor%0A%09pkg/snow/PreProcessor&In-Reply-To=%3C200903291034.n2TAYlBB003292%40sheep.berlios.de%3E"
       TITLE="[deprecated list] [Yade-dev] [svn] r1735 - in trunk: core extra	extra/clump	extra/spherical-dem-simulator extra/tetra gui/py	gui/qt3	pkg/common/Engine/DeusExMachina	pkg/common/Engine/EngineUnit	pkg/common/Engine/MetaEngine	pkg/common/Engine/StandAloneEngine	pkg/dem/Engine/DeusExMachina	pkg/dem/Engine/StandAloneEngine	pkg/dem/PreProcessor	pkg/fem/Engine/StandAloneEngine	pkg/fem/PreProcessor	pkg/lattice/PreProcessor	pkg/mass-spring/Engine/StandAloneEngine	pkg/mass-spring/PreProcessor	pkg/realtime-rigidbody/Engine/StandAloneEngine	pkg/realtime-rigidbody/PreProcessor	pkg/snow/PreProcessor">eudoxos at mail.berlios.de
       </A><BR>
    <I>Sun Mar 29 12:34:47 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000894.html">[deprecated list] [Yade-dev] [svn] r1734 - trunk/extra
</A></li>
        <LI>Next message: <A HREF="000896.html">[deprecated list] [Yade-dev] removing PhysicalAction
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#895">[ date ]</a>
              <a href="thread.html#895">[ thread ]</a>
              <a href="subject.html#895">[ subject ]</a>
              <a href="author.html#895">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: eudoxos
Date: 2009-03-29 12:34:26 +0200 (Sun, 29 Mar 2009)
New Revision: 1735

Modified:
   trunk/core/BexContainer.hpp
   trunk/core/MetaBody.cpp
   trunk/core/MetaBody.hpp
   trunk/core/PhysicalAction.hpp
   trunk/extra/BrefcomTestGen.cpp
   trunk/extra/clump/Shop.cpp
   trunk/extra/spherical-dem-simulator/SphericalDEMSimulator.cpp
   trunk/extra/tetra/Tetra.cpp
   trunk/gui/py/yadeControl.cpp
   trunk/gui/qt3/SimulationController.cpp
   trunk/gui/qt3/SimulationController.hpp
   trunk/gui/qt3/YadeQtMainWindow.cpp
   trunk/pkg/common/Engine/DeusExMachina/CinemCNCEngine.cpp
   trunk/pkg/common/Engine/DeusExMachina/CinemKNCEngine.cpp
   trunk/pkg/common/Engine/DeusExMachina/DisplacementToForceEngine.cpp
   trunk/pkg/common/Engine/DeusExMachina/GravityEngines.cpp
   trunk/pkg/common/Engine/DeusExMachina/MomentEngine.cpp
   trunk/pkg/common/Engine/EngineUnit/CundallNonViscousDamping.cpp
   trunk/pkg/common/Engine/EngineUnit/CundallNonViscousDamping.hpp
   trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.cpp
   trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.hpp
   trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.cpp
   trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.hpp
   trunk/pkg/common/Engine/MetaEngine/ConstitutiveLaw.hpp
   trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.cpp
   trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.hpp
   trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplierUnit.hpp
   trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.cpp
   trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.hpp
   trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamperUnit.hpp
   trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerInitializer.cpp
   trunk/pkg/dem/Engine/DeusExMachina/CapillaryRecorder.cpp
   trunk/pkg/dem/Engine/DeusExMachina/HydraulicForceEngine.cpp
   trunk/pkg/dem/Engine/DeusExMachina/MakeItFlat.cpp
   trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.cpp
   trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.hpp
   trunk/pkg/dem/Engine/DeusExMachina/TriaxialStressController.cpp
   trunk/pkg/dem/Engine/DeusExMachina/WallStressRecorder.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/CapillaryCohesiveLaw.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/CohesiveFrictionalContactLaw.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/ContactLaw1.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/ElasticCohesiveLaw.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/ForceRecorder.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/GeometricalModelForceColorizer.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/MyTetrahedronLaw.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/ViscousForceDamping.cpp
   trunk/pkg/dem/Engine/StandAloneEngine/VolumicContactLaw.cpp
   trunk/pkg/dem/PreProcessor/CohesiveTriaxialTest.cpp
   trunk/pkg/dem/PreProcessor/DirectShearCis.cpp
   trunk/pkg/dem/PreProcessor/Funnel.cpp
   trunk/pkg/dem/PreProcessor/HydraulicTest.cpp
   trunk/pkg/dem/PreProcessor/MembraneTest.cpp
   trunk/pkg/dem/PreProcessor/ModifiedTriaxialTest.cpp
   trunk/pkg/dem/PreProcessor/SDECImpactTest.cpp
   trunk/pkg/dem/PreProcessor/SDECLinkedSpheres.cpp
   trunk/pkg/dem/PreProcessor/SDECMovingWall.cpp
   trunk/pkg/dem/PreProcessor/SDECSpheresPlane.cpp
   trunk/pkg/dem/PreProcessor/STLImporterTest.cpp
   trunk/pkg/dem/PreProcessor/SimpleShear.cpp
   trunk/pkg/dem/PreProcessor/TestSimpleViscoelastic.cpp
   trunk/pkg/dem/PreProcessor/TetrahedronsTest.cpp
   trunk/pkg/dem/PreProcessor/ThreePointBending.cpp
   trunk/pkg/dem/PreProcessor/TriaxialTest.cpp
   trunk/pkg/dem/PreProcessor/TriaxialTest.hpp
   trunk/pkg/dem/PreProcessor/TriaxialTestWater.cpp
   trunk/pkg/fem/Engine/StandAloneEngine/FEMLaw.cpp
   trunk/pkg/fem/PreProcessor/FEMBeam.cpp
   trunk/pkg/lattice/PreProcessor/LatticeExample.cpp
   trunk/pkg/mass-spring/Engine/StandAloneEngine/MassSpringLaw.cpp
   trunk/pkg/mass-spring/PreProcessor/HangingCloth.cpp
   trunk/pkg/realtime-rigidbody/Engine/StandAloneEngine/FrictionLessElasticContactLaw.cpp
   trunk/pkg/realtime-rigidbody/PreProcessor/BoxStack.cpp
   trunk/pkg/realtime-rigidbody/PreProcessor/RotatingBox.cpp
   trunk/pkg/snow/PreProcessor/SnowCreepTest.cpp
   trunk/pkg/snow/PreProcessor/SnowVoxelsLoader.cpp
Log:
1. Remove MetaBody::physicalActions if compiling with BEX_CONTAINER (default)
2. Make everything work with both BexContainer and deprecated PhysicalActionContainer
3. Change PhysicalActionDamper, PhysicalActionDamperUnit, PhysicalActionApplier and PhysicalActionApplierUnit to dispatch only according to PhysicalParameters (not PhysicalAction anymore). That means that only one unit will be called for each body and that NewtonsMomentumLaw has to do the job of NewtonsForceLaw as well (same for CundallNonViscousMomentumDamping).
4. Fix (finally) defaultDt computation in TriaxialTest (forgotten assignment to defaultDt in the GlobalStiffnessTimeStepper)
5. Fix (finally?) timestep manipulation form within the QtGUI. If reloading the same file, timestep settings will be preserved, otherwise those saved in the XML are used.



Modified: trunk/core/BexContainer.hpp
===================================================================
--- trunk/core/BexContainer.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/core/BexContainer.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -28,6 +28,12 @@
 		}
 
 		inline void ensureSynced(){ if(!synced) throw runtime_error(&quot;BexContainer not thread-synchronized; call sync() first!&quot;); }
+
+		/*! Function to allow friend classes to get force even if not synced.
+		* Dangerous! The caller must know what it is doing! */
+		const Vector3r&amp; getForceUnsynced (body_id_t id){ensureSize(id); return _force[id];}
+		const Vector3r&amp; getTorqueUnsynced(body_id_t id){ensureSize(id); return _force[id];}
+		friend class PhysicalActionDamperUnit;
 	public:
 		BexContainer(): size(0), synced(true),syncCount(0){
 			nThreads=omp_get_max_threads();
@@ -102,6 +108,9 @@
 		std::vector&lt;Vector3r&gt; _torque;
 		size_t size;
 		inline void ensureSize(body_id_t id){ if(size&lt;=(size_t)id) resize(min((size_t)1.5*(id+100),(size_t)(id+2000)));}
+		friend class PhysicalActionDamperUnit;
+		const Vector3r&amp; getForceUnsynced (body_id_t id){ return getForce(id);}
+		const Vector3r&amp; getTorqueUnsynced(body_id_t id){ return getForce(id);}
 	public:
 		BexContainer(): size(0),syncCount(0){}
 		const Vector3r&amp; getForce(body_id_t id){ensureSize(id); return _force[id];}

Modified: trunk/core/MetaBody.cpp
===================================================================
--- trunk/core/MetaBody.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/core/MetaBody.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -35,7 +35,10 @@
 bool TimingInfo::enabled=false;
 
 MetaBody::MetaBody() :
-	  Body(),bodies(new BodyRedirectionVector), interactions(new InteractionVecMap), persistentInteractions(interactions),transientInteractions(interactions),physicalActions(new PhysicalActionVectorVector)
+	Body(),bodies(new BodyRedirectionVector), interactions(new InteractionVecMap), persistentInteractions(interactions),transientInteractions(interactions)
+	#ifndef BEX_CONTAINER
+	  	,physicalActions(new PhysicalActionVectorVector)
+	#endif
 {	
 	engines.clear();
 	initializers.clear();

Modified: trunk/core/MetaBody.hpp
===================================================================
--- trunk/core/MetaBody.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/core/MetaBody.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -29,9 +29,10 @@
 		__attribute__((__deprecated__)) shared_ptr&lt;InteractionContainer&gt;&amp;	persistentInteractions; // disappear, reappear according to physical (or any other non-spatial) criterion
 		shared_ptr&lt;InteractionContainer&gt;&amp;	transientInteractions;	// disappear, reappear according to spatial criterion
 
-		shared_ptr&lt;PhysicalActionContainer&gt;	physicalActions;
 		#ifdef BEX_CONTAINER
 			BexContainer bex;
+		#else
+			shared_ptr&lt;PhysicalActionContainer&gt;	physicalActions;
 		#endif
 		vector&lt;shared_ptr&lt;Serializable&gt; &gt; miscParams; // will set static parameters during deserialization (primarily for GLDraw functors which otherwise have no attribute access)
 		//! tags like mp3 tags: author, date, version, description etc.
@@ -65,7 +66,9 @@
 		(initializers)
 		(bodies)
 		(transientInteractions)
-		(physicalActions)
+		#ifndef BEX_CONTAINER
+			(physicalActions)
+		#endif
 		(miscParams)
 		(dispParams)
 		(dt)

Modified: trunk/core/PhysicalAction.hpp
===================================================================
--- trunk/core/PhysicalAction.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/core/PhysicalAction.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -20,9 +20,6 @@
 class PhysicalAction : public Serializable, public Indexable
 {
 	public :
-// FIXME - correct usage of this class, so that functions add(), etc.. are actually used!
-//		virtual void add(const shared_ptr&lt;PhysicalAction&gt;&amp; )	{throw;};
-//		virtual void sub(const shared_ptr&lt;PhysicalAction&gt;&amp; )	{throw;};
 
 		virtual void reset() 				{throw;};
 		virtual shared_ptr&lt;PhysicalAction&gt; clone()	{throw;};

Modified: trunk/extra/BrefcomTestGen.cpp
===================================================================
--- trunk/extra/BrefcomTestGen.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/extra/BrefcomTestGen.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -6,26 +6,8 @@
 YADE_PLUGIN(&quot;BrefcomTestGen&quot;);
 
 
-/************************ BrefcomTestGen ****************************/
-/*#include&lt;yade/pkg-common/MetaInteractingGeometry2AABB.hpp&gt;
-#include&lt;yade/pkg-common/MetaInteractingGeometry.hpp&gt;
-#include&lt;yade/pkg-common/Box.hpp&gt;
-#include&lt;yade/pkg-common/Sphere.hpp&gt;
-#include&lt;yade/pkg-common/PersistentSAPCollider.hpp&gt;
 
-#include&lt;yade/pkg-common/BodyRedirectionVector.hpp&gt;
-#include&lt;yade/pkg-common/InteractionVecSet.hpp&gt;
-#include&lt;yade/pkg-common/PhysicalActionVectorVector.hpp&gt;
 
-#include&lt;yade/pkg-common/InteractingBox.hpp&gt;
-
-#include&lt;yade/pkg-common/InteractingBox2AABB.hpp&gt;
-#include&lt;yade/pkg-common/Momentum.hpp&gt;
-#include&lt;yade/pkg-common/Force.hpp&gt;
-#include&lt;yade/pkg-dem/InteractingSphere2InteractingSphere4SpheresContactGeometry.hpp&gt;
-#include&lt;yade/pkg-dem/InteractingBox2InteractingSphere4SpheresContactGeometry.hpp&gt;*/
-
-
 #include&lt;yade/pkg-common/PhysicalActionContainerReseter.hpp&gt;
 #include&lt;yade/pkg-common/PhysicalActionContainerInitializer.hpp&gt;
 #include&lt;yade/pkg-common/InteractingSphere.hpp&gt;

Modified: trunk/extra/clump/Shop.cpp
===================================================================
--- trunk/extra/clump/Shop.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/extra/clump/Shop.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -232,9 +232,6 @@
 	shared_ptr&lt;AABB&gt; aabb(new AABB); aabb-&gt;diffuseColor=Vector3r(0,0,1);
 	rootBody-&gt;boundingVolume=YADE_PTR_CAST&lt;BoundingVolume&gt;(aabb);
 	
-	rootBody-&gt;transientInteractions=shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions=shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
-	rootBody-&gt;bodies=shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	return rootBody;
 }

Modified: trunk/extra/spherical-dem-simulator/SphericalDEMSimulator.cpp
===================================================================
--- trunk/extra/spherical-dem-simulator/SphericalDEMSimulator.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/extra/spherical-dem-simulator/SphericalDEMSimulator.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -206,12 +206,19 @@
 		shared_ptr&lt;PhysicalActionDamper&gt; pade = dynamic_pointer_cast&lt;PhysicalActionDamper&gt;(e);
 		if (pade)
 		{	
+		#ifdef BEX_CONTAINER
+			shared_ptr&lt;CundallNonViscousForceDamping&gt; cnvfd = YADE_PTR_CAST&lt;CundallNonViscousForceDamping&gt;(pade-&gt;getExecutor(&quot;RigidBodyParameters&quot;));
+			assert(cnvfd);
+			forceDamping=cnvfd-&gt;damping;
+			momentumDamping=forceDamping;
+		#else
 			shared_ptr&lt;CundallNonViscousForceDamping&gt; cnvfd = YADE_PTR_CAST&lt;CundallNonViscousForceDamping&gt;(pade-&gt;getExecutor(&quot;Force&quot;,&quot;RigidBodyParameters&quot;));
 			shared_ptr&lt;CundallNonViscousMomentumDamping&gt; cnvmd = YADE_PTR_CAST&lt;CundallNonViscousMomentumDamping&gt;(pade-&gt;getExecutor(&quot;Momentum&quot;,&quot;RigidBodyParameters&quot;));
 			assert(cnvfd);
 			assert(cnvmd);
 			forceDamping 	= cnvfd-&gt;damping;
 			momentumDamping = cnvmd-&gt;damping;
+		#endif
 		}
 	}
 }

Modified: trunk/extra/tetra/Tetra.cpp
===================================================================
--- trunk/extra/tetra/Tetra.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/extra/tetra/Tetra.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -405,10 +405,17 @@
 		TRWM3VEC(F);
 		TRWM3VEC((physB-&gt;se3.position-contactGeom-&gt;contactPoint).Cross(F));
 
-		static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(idA,actionForce-&gt;getClassIndex()))-&gt;force-=F;
-		static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(idB,actionForce-&gt;getClassIndex()))-&gt;force+=F;
-		static_pointer_cast&lt;Momentum&gt;(rootBody-&gt;physicalActions-&gt;find(idA,actionMomentum-&gt;getClassIndex()))-&gt;momentum-=(physA-&gt;se3.position-contactGeom-&gt;contactPoint).Cross(F);
-		static_pointer_cast&lt;Momentum&gt;(rootBody-&gt;physicalActions-&gt;find(idB,actionMomentum-&gt;getClassIndex()))-&gt;momentum+=(physB-&gt;se3.position-contactGeom-&gt;contactPoint).Cross(F);
+		#ifdef BEX_CONTAINER
+			rootBody-&gt;bex.addForce (idA,-F);
+			rootBody-&gt;bex.addForce (idB, F);
+			rootBody-&gt;bex.addTorque(idA,-(physA-&gt;se3.position-contactGeom-&gt;contactPoint).Cross(F));
+			rootBody-&gt;bex.addTorque(idB, (physA-&gt;se3.position-contactGeom-&gt;contactPoint).Cross(F));
+		#else
+			static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(idA,actionForce-&gt;getClassIndex()))-&gt;force-=F;
+			static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(idB,actionForce-&gt;getClassIndex()))-&gt;force+=F;
+			static_pointer_cast&lt;Momentum&gt;(rootBody-&gt;physicalActions-&gt;find(idA,actionMomentum-&gt;getClassIndex()))-&gt;momentum-=(physA-&gt;se3.position-contactGeom-&gt;contactPoint).Cross(F);
+			static_pointer_cast&lt;Momentum&gt;(rootBody-&gt;physicalActions-&gt;find(idB,actionMomentum-&gt;getClassIndex()))-&gt;momentum+=(physB-&gt;se3.position-contactGeom-&gt;contactPoint).Cross(F);
+		#endif
 	}
 }
 

Modified: trunk/gui/py/yadeControl.cpp
===================================================================
--- trunk/gui/py/yadeControl.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/gui/py/yadeControl.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -633,14 +633,15 @@
 		rb-&gt;bodies=bc;
 	}
 	string bodyContainer_get(string clss){ return OMEGA.getRootBody()-&gt;bodies-&gt;getClassName(); }
+	#ifndef BEX_CONTAINER
+		void physicalActionContainer_set(string clss){
+			MetaBody* rb=OMEGA.getRootBody().get();
+			shared_ptr&lt;PhysicalActionContainer&gt; pac=dynamic_pointer_cast&lt;PhysicalActionContainer&gt;(ClassFactory::instance().createShared(clss));
+			rb-&gt;physicalActions=pac;
+		}
+		string physicalActionContainer_get(string clss){ return OMEGA.getRootBody()-&gt;physicalActions-&gt;getClassName(); }
+	#endif
 
-	void physicalActionContainer_set(string clss){
-		MetaBody* rb=OMEGA.getRootBody().get();
-		shared_ptr&lt;PhysicalActionContainer&gt; pac=dynamic_pointer_cast&lt;PhysicalActionContainer&gt;(ClassFactory::instance().createShared(clss));
-		rb-&gt;physicalActions=pac;
-	}
-	string physicalActionContainer_get(string clss){ return OMEGA.getRootBody()-&gt;physicalActions-&gt;getClassName(); }
-
 };
 BOOST_PYTHON_MEMBER_FUNCTION_OVERLOADS(omega_run_overloads,run,0,2);
 
@@ -698,7 +699,6 @@
 		.def(&quot;isChildClassOf&quot;,&amp;pyOmega::isChildClassOf)
 		.add_property(&quot;bodyContainer&quot;,&amp;pyOmega::bodyContainer_get,&amp;pyOmega::bodyContainer_set)
 		.add_property(&quot;interactionContainer&quot;,&amp;pyOmega::interactionContainer_get,&amp;pyOmega::interactionContainer_set)
-		.add_property(&quot;actionContainer&quot;,&amp;pyOmega::physicalActionContainer_get,&amp;pyOmega::physicalActionContainer_set)
 		.add_property(&quot;timingEnabled&quot;,&amp;pyOmega::timingEnabled_get,&amp;pyOmega::timingEnabled_set)
 		#ifdef BEX_CONTAINER
 			.add_property(&quot;bexSyncCount&quot;,&amp;pyOmega::bexSyncCount_get,&amp;pyOmega::bexSyncCount_set)

Modified: trunk/gui/qt3/SimulationController.cpp
===================================================================
--- trunk/gui/qt3/SimulationController.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/gui/qt3/SimulationController.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -75,13 +75,15 @@
 	maxNbViews=0;
 	//addNewView(); // postpone until a file is loaded
 
-	// there is file existence assertion in lodSimulationFromFilename, so yade will abort cleanly...
+	// there is file existence assertion in loadSimulationFromFilename, so yade will abort cleanly...
 	LOG_DEBUG(&quot;Omega's simulation filename: `&quot;&lt;&lt;Omega::instance().getSimulationFileName()&lt;&lt;&quot;'&quot;);
 	if (Omega::instance().getSimulationFileName()!=&quot;&quot; &amp;&amp; (!Omega::instance().getRootBody() || (Omega::instance().getRootBody()-&gt;bodies-&gt;size()==0 &amp;&amp; Omega::instance().getRootBody()-&gt;engines.size()==0))){
 		loadSimulationFromFileName(Omega::instance().getSimulationFileName());
 	}
+	else{ LOG_DEBUG(&quot;Not loading simulation in ctor&quot;); }
 	// run timer ANY TIME (simulation may be started asynchronously)
 	updateTimerId=startTimer(refreshTime);
+
 }
 
 /* restart timer with SimulationController::refreshTime */
@@ -131,16 +133,23 @@
 }
 
 
-void SimulationController::loadSimulationFromFileName(const std::string&amp; fileName,bool center, bool useTimeStepperIfPresent)
+void SimulationController::loadSimulationFromFileName(const std::string&amp; fileName,bool center)
 {
 	assert(filesystem::exists(fileName) || fileName.find(&quot;:memory:&quot;)==(size_t)0);
 
 		Omega::instance().finishSimulationLoop();
 		Omega::instance().joinSimulationLoop();
 
+
+		bool keepTimeStepperSettings=Omega::instance().getSimulationFileName()==fileName;
+		Real prevDt=Omega::instance().getTimeStep();
+		bool timeStepperUsed=Omega::instance().timeStepperActive();
+
 		Omega::instance().setSimulationFileName(fileName);
 		try
 		{
+			//boost::mutex::scoped_lock lock(timeMutex);
+
 			Omega::instance().loadSimulation(); // expecting throw here.
 			string fullName = string(filesystem::basename(fileName.data()))+string(filesystem::extension(fileName.data()));
 			tlCurrentSimulation-&gt;setText(fullName); 
@@ -151,6 +160,24 @@
 			pbResetSimulation-&gt;setEnabled(true);
 			pbOneSimulationStep-&gt;setEnabled(true);
 
+			if(keepTimeStepperSettings){
+				LOG_DEBUG(&quot;The same simulation loaded again, keeping time stepper settings.&quot;);
+				// if we were using fixed time, set that fixed value now
+				if(!timeStepperUsed) { Omega::instance().setTimeStep(prevDt); LOG_DEBUG(&quot;Using previous fixed time step &quot;&lt;&lt;prevDt);}
+				// recover whether timestepper was used or not
+				Omega::instance().skipTimeStepper(!timeStepperUsed);
+				LOG_DEBUG(&quot;Timestepper is &quot;&lt;&lt;(timeStepperUsed?&quot;&quot;:&quot;NOT &quot;)&lt;&lt;&quot;being used.&quot;);
+			}
+			else {
+				LOG_DEBUG(&quot;New simulation loaded, timestepper is &quot;&lt;&lt;(Omega::instance().timeStepperActive()?&quot;&quot;:&quot;NOT &quot;)&lt;&lt;&quot;being used (as per XML).&quot;);
+			}
+
+			//rbTimeStepper-&gt;setEnabled(Omega::instance().containTimeStepper());
+			//LOG_DEBUG(&quot;(Un)checking rbTimeStepper and rbFixed.&quot;);
+			//rbTimeStepper-&gt;setChecked(Omega::instance().timeStepperActive());
+			//rbFixed-&gt;setChecked(!Omega::instance().timeStepperActive());
+
+			#if 0
 			Real dt=Omega::instance().getTimeStep();
 			int exp10=(int)floor(log10(dt));
 			sbSecond-&gt;setValue((int)(dt/(pow(10.,exp10)))); // we may lose quite some precision here :-(
@@ -170,6 +197,7 @@
 				wasUsingTimeStepper = false;
 			}
 			skipTimeStepper=!wasUsingTimeStepper;
+			#endif
 		} 
 		catch(SerializableError&amp; e) // catching it...
 		{
@@ -267,7 +295,7 @@
 	pbStopClicked();
 
 	std::string name=Omega::instance().getSimulationFileName(); 
-	loadSimulationFromFileName(name,false /* don't re-center scene */,wasUsingTimeStepper /* respect timeStepper setting from the prvious run*/);
+	loadSimulationFromFileName(name,false /* don't re-center scene */);
 
 	if(Omega::instance().getRootBody())
 	{
@@ -293,22 +321,34 @@
 	/* i: buttonGroupId, which is 0 for timeStepper, 2 for fixed step */
 	switch (i)
 	{
-		case 0 : //Use timeStepper
-			changeSkipTimeStepper = true;
-			skipTimeStepper = false;
+		case 0 : {//Use timeStepper
+			//changeSkipTimeStepper = true;
+			//skipTimeStepper = false;
 			wasUsingTimeStepper=true;
+			//boost::mutex::scoped_lock lock(timeMutex);
+			Omega::instance().skipTimeStepper(false);
 			break;
+			}
 		case 1 : // Try RealTime -- deprecated
-			changeSkipTimeStepper = true;
-			skipTimeStepper = true;
-			wasUsingTimeStepper=false;
+			//changeSkipTimeStepper = true;
+			//skipTimeStepper = true;
+			//wasUsingTimeStepper=false;
+			throw logic_error(&quot;RealTime timestep is deprecated and you couldn't click on it!&quot;);
 			break;
-		case 2 : // use fixed time Step
-			changeSkipTimeStepper = true;
-			skipTimeStepper = true;
+		case 2 : {// use fixed time Step
+			//changeSkipTimeStepper = true;
+			//skipTimeStepper = true;
+			//boost::mutex::scoped_lock lock(timeMutex);
 			changeTimeStep = true;
 			wasUsingTimeStepper=false;
+			Omega::instance().skipTimeStepper(true);
+			if(sbSecond-&gt;value()==0){ sbSecond-&gt;setValue(9); sb10PowerSecond-&gt;setValue(sb10PowerSecond-&gt;value()-1); }
+			if(sbSecond-&gt;value()==10){ sbSecond-&gt;setValue(1); sb10PowerSecond-&gt;setValue(sb10PowerSecond-&gt;value()+1); }
+			Real second = (Real)(sbSecond-&gt;value());
+			Real powerSecond = (Real)(sb10PowerSecond-&gt;value());
+			Omega::instance().setTimeStep(second*Mathr::Pow(10,powerSecond));
 			break;
+		}
 		default: break;
 	}
 
@@ -317,15 +357,19 @@
 
 void SimulationController::sb10PowerSecondValueChanged(int)
 {
-	if(!rbFixed-&gt;isOn()){ rbFixed-&gt;toggle(); bgTimeStepClicked(2); } // this should do the callback as if user clicked fixed timestepper button
-	changeTimeStep = true;
+//	if(!rbFixed-&gt;isOn() &amp;&amp; userChangingTimestep){ rbFixed-&gt;toggle(); bgTimeStepClicked(2); } // this should do the callback as if user clicked fixed timestepper button
+//	changeTimeStep = true;
+	//assert(rbFixed-&gt;isOn()); 
+	if(rbFixed-&gt;isOn()) bgTimeStepClicked(2);
 }
 
 
 void SimulationController::sbSecondValueChanged(int)
 { 
-	if(!rbFixed-&gt;isOn()){ rbFixed-&gt;toggle(); bgTimeStepClicked(2); } // dtto
-	changeTimeStep = true;
+//	if(!rbFixed-&gt;isOn() &amp;&amp; userChangingTimestep){ rbFixed-&gt;toggle(); bgTimeStepClicked(2); } // dtto
+//	changeTimeStep = true;
+	//assert(rbFixed-&gt;isOn());
+	if(rbFixed-&gt;isOn()) bgTimeStepClicked(2);
 }
 
 void SimulationController::sbRefreshValueChanged(int v)
@@ -399,29 +443,23 @@
     snprintf(strStopAtIter,64,&quot;stopAtIter #%ld&quot;,Omega::instance().getRootBody()-&gt;stopAtIteration);
     labelStopAtIter-&gt;setText(strStopAtIter);
 
-	if (changeSkipTimeStepper) Omega::instance().skipTimeStepper(skipTimeStepper);
-	if (changeTimeStep) {
-		// wrap the mantissa around
-		if(sbSecond-&gt;value()==0){ sbSecond-&gt;setValue(9); sb10PowerSecond-&gt;setValue(sb10PowerSecond-&gt;value()-1); }
-		if(sbSecond-&gt;value()==10){ sbSecond-&gt;setValue(1); sb10PowerSecond-&gt;setValue(sb10PowerSecond-&gt;value()+1); }
-		Real second = (Real)(sbSecond-&gt;value());
-		Real powerSecond = (Real)(sb10PowerSecond-&gt;value());
-		Omega::instance().setTimeStep(second*Mathr::Pow(10,powerSecond));
-	} else {
-		Real dt=Omega::instance().getTimeStep();
-		int exp10=floor(log10(dt));
-		sb10PowerSecond-&gt;setValue(exp10);
-		sbSecond-&gt;setValue((int)(.1+dt/(pow((float)10,exp10)))); // .1: rounding issues
-	}
+	//boost::mutex::scoped_lock lock(timeMutex);
 
+	//if (changeSkipTimeStepper) Omega::instance().skipTimeStepper(skipTimeStepper);
+	//if (changeTimeStep) {
+	//	// wrap the mantissa around
+	//} else {
+	//}
+
 	if(sbRefreshTime-&gt;value()!=refreshTime) sbRefreshTime-&gt;setValue(refreshTime);
 
+
 	char strStep[64];
 	snprintf(strStep,64,&quot;step %g&quot;,(double)Omega::instance().getTimeStep());
 	labelStep-&gt;setText(string(strStep));
 
-	changeSkipTimeStepper = false;
-	changeTimeStep = false;
+	//changeSkipTimeStepper = false;
+	//changeTimeStep = false;
 
 	//cerr&lt;&lt;&quot;dt=&quot;&lt;&lt;dt&lt;&lt;&quot;,exp10=&quot;&lt;&lt;exp10&lt;&lt;&quot;,10^exp10=&quot;&lt;&lt;pow((float)10,exp10)&lt;&lt;endl;
 
@@ -437,9 +475,17 @@
 	pbResetSimulation-&gt;setEnabled(hasSimulation &amp;&amp; hasFileName);
 	pbOneSimulationStep-&gt;setEnabled(hasSimulation &amp;&amp; !isRunning);
 	rbTimeStepper-&gt;setEnabled(hasTimeStepper);
+	sbSecond-&gt;setEnabled(!usesTimeStepper);
+	sb10PowerSecond-&gt;setEnabled(!usesTimeStepper);
+
 	// conditionals only avoid setting the state that is already set, to avoid spurious signals
-	if(rbFixed-&gt;isChecked()==usesTimeStepper) rbFixed-&gt;setChecked(!usesTimeStepper);
-	if(rbTimeStepper-&gt;isChecked()!=usesTimeStepper) rbTimeStepper-&gt;setChecked(usesTimeStepper);
+	if(rbFixed-&gt;isChecked()==usesTimeStepper){ LOG_DEBUG(&quot;Checking rbFixed&quot;); rbFixed-&gt;setChecked(!usesTimeStepper); }
+	if(rbTimeStepper-&gt;isChecked()!=usesTimeStepper){ LOG_DEBUG(&quot;Checking rbTimeStepper&quot;); rbTimeStepper-&gt;setChecked(usesTimeStepper); }
 
+	Real dt=Omega::instance().getTimeStep();
+	int exp10=floor(log10(dt));
+	sb10PowerSecond-&gt;setValue(exp10);
+	sbSecond-&gt;setValue((int)(.1+dt/(pow((float)10,exp10)))); // .1: rounding issues
+
 }
 

Modified: trunk/gui/qt3/SimulationController.hpp
===================================================================
--- trunk/gui/qt3/SimulationController.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/gui/qt3/SimulationController.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -42,6 +42,8 @@
         boost::posix_time::time_duration estimation;
 		boost::posix_time::ptime iterPerSec_LastLocalTime;
 
+		boost::mutex timeMutex;
+
 	
 		void doUpdate();
 		void restartTimer();
@@ -52,7 +54,7 @@
 		void addNewView();
 	
 	public : 
-		void loadSimulationFromFileName(const std::string&amp; fileName,bool center=true, bool useTimeStepperIfPresent=true);
+		void loadSimulationFromFileName(const std::string&amp; fileName,bool center=true);
 		bool changeSkipTimeStepper,skipTimeStepper,changeTimeStep,wasUsingTimeStepper;
 		SimulationController (QWidget * parent=NULL);
 		virtual ~SimulationController () {}; 

Modified: trunk/gui/qt3/YadeQtMainWindow.cpp
===================================================================
--- trunk/gui/qt3/YadeQtMainWindow.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/gui/qt3/YadeQtMainWindow.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -98,7 +98,7 @@
 	}
 }
 
-void YadeQtMainWindow::loadSimulation(string file){createController();	controller-&gt;loadSimulationFromFileName(file); lookDown(glViews[0]);}
+void YadeQtMainWindow::loadSimulation(string file){createController(); while(!(bool)(controller)) usleep(50000); controller-&gt;loadSimulationFromFileName(file); lookDown(glViews[0]);}
 void YadeQtMainWindow::centerViews(){FOREACH(const shared_ptr&lt;GLViewer&gt;&amp; glv,glViews){ if(glv){ glv-&gt;centerScene();}}}
 
 

Modified: trunk/pkg/common/Engine/DeusExMachina/CinemCNCEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/DeusExMachina/CinemCNCEngine.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/DeusExMachina/CinemCNCEngine.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -187,8 +187,11 @@
 
 void CinemCNCEngine::computeDu(MetaBody* ncb)
 {
-
-	Vector3r&amp; F_sup = dynamic_cast&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find(id_boxhaut,actionForce-&gt;getClassIndex()) . get() )-&gt;force;
+	#ifdef BEX_CONTAINER
+		ncb-&gt;bex.sync(); Vector3r F_sup=ncb-&gt;bex.getForce(id_boxhaut);
+	#else
+		Vector3r&amp; F_sup = dynamic_cast&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find(id_boxhaut,actionForce-&gt;getClassIndex()) . get() )-&gt;force;
+	#endif
 	
 	if(firstRun)
 	{

Modified: trunk/pkg/common/Engine/DeusExMachina/CinemKNCEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/DeusExMachina/CinemKNCEngine.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/DeusExMachina/CinemKNCEngine.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -180,7 +180,11 @@
 void CinemKNCEngine::computeDu(MetaBody* ncb)
 {
 
-	Vector3r&amp; F_sup = dynamic_cast&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find(id_boxhaut,actionForce-&gt;getClassIndex()) . get() )-&gt;force;
+	#ifdef BEX_CONTAINER
+		ncb-&gt;bex.sync(); Vector3r F_sup=ncb-&gt;bex.getForce(id_boxhaut);
+	#else
+		Vector3r&amp; F_sup = dynamic_cast&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find(id_boxhaut,actionForce-&gt;getClassIndex()) . get() )-&gt;force;
+	#endif
 	
 	if(firstRun)
 	{

Modified: trunk/pkg/common/Engine/DeusExMachina/DisplacementToForceEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/DeusExMachina/DisplacementToForceEngine.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/DeusExMachina/DisplacementToForceEngine.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -56,10 +56,18 @@
 	std::vector&lt;int&gt;::const_iterator ii = subscribedBodies.begin();
 	std::vector&lt;int&gt;::const_iterator iiEnd = subscribedBodies.end();
 
+	#ifdef BEX_CONTAINER
+		ncb-&gt;bex.sync();
+	#endif
+
 	for(;ii!=iiEnd;++ii)
 		if( bodies-&gt;exists(*ii) )
 		{
-			Vector3r current_force=static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find( ((*bodies)[*ii])-&gt;getId() , actionParameterForce-&gt;getClassIndex() ).get() )-&gt;force;
+			#ifdef BEX_CONTAINER
+				Vector3r current_force=ncb-&gt;bex.getForce(*ii);
+			#else
+				Vector3r current_force=static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(*ii,actionParameterForce-&gt;getClassIndex() ).get() )-&gt;force;
+			#endif
 
 			Real current_length_sq = 
 				  (targetForceMask[0] != 0) ? current_force[0]*current_force[0]:0.0 

Modified: trunk/pkg/common/Engine/DeusExMachina/GravityEngines.cpp
===================================================================
--- trunk/pkg/common/Engine/DeusExMachina/GravityEngines.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/DeusExMachina/GravityEngines.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -24,11 +24,11 @@
 		if(b-&gt;isClumpMember()) continue;
 		shared_ptr&lt;ParticleParameters&gt; p=YADE_PTR_CAST&lt;ParticleParameters&gt;(b-&gt;physicalParameters);
 		if(p!=0) //not everything derives from ParticleParameters; this line was    assert(p); - Janek
-#ifdef BEX_CONTAINER
+		#ifdef BEX_CONTAINER
 			ncb-&gt;bex.addForce(b-&gt;getId(),gravity*p-&gt;mass);
-#else
+		#else
 			static_cast&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find(b-&gt;getId(),cachedForceClassIndex).get())-&gt;force+=gravity*p-&gt;mass;
-#endif
+		#endif
 	}
 }
 
@@ -38,13 +38,13 @@
 		if(b-&gt;isClumpMember() || b-&gt;getId()==centralBody) continue; // skip clump members and central body
 		Real F=accel*YADE_PTR_CAST&lt;ParticleParameters&gt;(b-&gt;physicalParameters)-&gt;mass;
 		Vector3r toCenter=centralPos-b-&gt;physicalParameters-&gt;se3.position; toCenter.Normalize();
-#ifdef BEX_CONTAINER
-		rootBody-&gt;bex.addForce(b-&gt;getId(),F*toCenter);
-		if(reciprocal) rootBody-&gt;bex.addForce(centralBody,-F*toCenter);
-#else
-		static_cast&lt;Force*&gt;(rootBody-&gt;physicalActions-&gt;find(b-&gt;getId(),cachedForceClassIndex).get())-&gt;force+=F*toCenter;
-		if(reciprocal) static_cast&lt;Force*&gt;(rootBody-&gt;physicalActions-&gt;find(centralBody,cachedForceClassIndex).get())-&gt;force-=F*toCenter;
-#endif
+		#ifdef BEX_CONTAINER
+			rootBody-&gt;bex.addForce(b-&gt;getId(),F*toCenter);
+			if(reciprocal) rootBody-&gt;bex.addForce(centralBody,-F*toCenter);
+		#else
+			static_cast&lt;Force*&gt;(rootBody-&gt;physicalActions-&gt;find(b-&gt;getId(),cachedForceClassIndex).get())-&gt;force+=F*toCenter;
+			if(reciprocal) static_cast&lt;Force*&gt;(rootBody-&gt;physicalActions-&gt;find(centralBody,cachedForceClassIndex).get())-&gt;force-=F*toCenter;
+		#endif
 	}
 }
 
@@ -58,11 +58,11 @@
 		const Vector3r x2=axisPoint+axisDirection;
 		Vector3r closestAxisPoint=(x2-x1) * /* t */ (-(x1-x0).Dot(x2-x1))/((x2-x1).SquaredLength());
 		Vector3r toAxis=closestAxisPoint-x0; toAxis.Normalize();
-#ifdef BEX_CONTAINER
-		rootBody-&gt;bex.addForce(b-&gt;getId(),acceleration*myMass*toAxis);
-#else
-		static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(b-&gt;getId(),cachedForceClassIndex))-&gt;force+=acceleration*myMass*toAxis;
-		//if(b-&gt;getId()==20){ TRVAR3(toAxis,acceleration*myMass*toAxis,static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(b-&gt;getId(),cachedForceClassIndex))-&gt;force); }
-#endif
+		#ifdef BEX_CONTAINER
+			rootBody-&gt;bex.addForce(b-&gt;getId(),acceleration*myMass*toAxis);
+		#else
+			static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(b-&gt;getId(),cachedForceClassIndex))-&gt;force+=acceleration*myMass*toAxis;
+			//if(b-&gt;getId()==20){ TRVAR3(toAxis,acceleration*myMass*toAxis,static_pointer_cast&lt;Force&gt;(rootBody-&gt;physicalActions-&gt;find(b-&gt;getId(),cachedForceClassIndex))-&gt;force); }
+		#endif
 	}
 }

Modified: trunk/pkg/common/Engine/DeusExMachina/MomentEngine.cpp
===================================================================
--- trunk/pkg/common/Engine/DeusExMachina/MomentEngine.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/DeusExMachina/MomentEngine.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -40,7 +40,11 @@
 	{
 		if(ncb-&gt;bodies-&gt;exists( *ii ))
 		{
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( *ii        , actionParameterMoment-&gt;getClassIndex() ).get() )-&gt;momentum += moment;
+			#ifdef BEX_CONTAINER
+				ncb-&gt;bex.addTorque(*ii,moment);
+			#else
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( *ii        , actionParameterMoment-&gt;getClassIndex() ).get() )-&gt;momentum += moment;
+			#endif
 		} else {
 			std::cerr &lt;&lt; &quot;MomentEngine: body &quot; &lt;&lt; *ii &lt;&lt; &quot;doesn't exist, cannot apply moment.&quot;;
 		}

Modified: trunk/pkg/common/Engine/EngineUnit/CundallNonViscousDamping.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/CundallNonViscousDamping.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/EngineUnit/CundallNonViscousDamping.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -8,6 +8,30 @@
 
 YADE_PLUGIN(&quot;CundallNonViscousForceDamping&quot;,&quot;CundallNonViscousMomentumDamping&quot;);
 
+#ifdef BEX_CONTAINER
+//! damping of force, for bodies that have only ParticleParameters
+void CundallNonViscousForceDamping::go(const shared_ptr&lt;PhysicalParameters&gt;&amp; pp, const Body* body, MetaBody* rb){
+	if(body-&gt;isClump()) return;
+	Vector3r f=getForceUnsynced(body-&gt;getId(),rb);
+	ParticleParameters *p=static_cast&lt;ParticleParameters*&gt;(pp.get());
+	Vector3r df=Vector3r::ZERO;
+	for(int i=0; i&lt;3; i++){df[i]=-f[i]*damping*Mathr::Sign(f[i]*p-&gt;velocity[i]);}
+	rb-&gt;bex.addForce(body-&gt;getId(),df);
+}
+//! damping of both force and torque, for bodies that have RigidBodyParameters
+void CundallNonViscousMomentumDamping::go(const shared_ptr&lt;PhysicalParameters&gt;&amp; pp, const Body* body, MetaBody* rb){
+	if(body-&gt;isClump()) return;
+	body_id_t id=body-&gt;getId();
+	Vector3r f=getForceUnsynced(id,rb),t=getTorqueUnsynced(id,rb);
+	RigidBodyParameters *p=static_cast&lt;RigidBodyParameters*&gt;(pp.get());
+	Vector3r df=Vector3r::ZERO, dt=Vector3r::ZERO;
+	for(int i=0; i&lt;3; i++){
+		df[i]=-f[i]*damping*Mathr::Sign(f[i]*p-&gt;velocity[i]);
+		dt[i]=-t[i]*damping*Mathr::Sign(t[i]*p-&gt;angularVelocity[i]);
+	}
+	rb-&gt;bex.addForce(id,df); rb-&gt;bex.addTorque(id,dt);
+}
+#else
 // this is Cundall non-viscous local damping, applied to force (Force)
 void CundallNonViscousForceDamping::go(    const shared_ptr&lt;PhysicalAction&gt;&amp; a
 						, const shared_ptr&lt;PhysicalParameters&gt;&amp; b
@@ -38,8 +62,8 @@
 		m[i] *= 1 - damping*Mathr::Sign(m[i]*rb-&gt;angularVelocity[i]);	
 	}
 }
+#endif
 
 
 
 
-

Modified: trunk/pkg/common/Engine/EngineUnit/CundallNonViscousDamping.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/CundallNonViscousDamping.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/EngineUnit/CundallNonViscousDamping.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -6,16 +6,16 @@
 	public:
 		Real damping;
 		CundallNonViscousForceDamping(): damping(0){};
+		virtual void registerAttributes(){PhysicalActionDamperUnit::registerAttributes();REGISTER_ATTRIBUTE(damping);}
+	#ifdef BEX_CONTAINER
+		virtual void go(const shared_ptr&lt;PhysicalParameters&gt;&amp;, const Body*, MetaBody*);
+		FUNCTOR1D(ParticleParameters);
+	#else
 		virtual void go(const shared_ptr&lt;PhysicalAction&gt;&amp;, const shared_ptr&lt;PhysicalParameters&gt;&amp; , const Body*);
-	protected:
-		virtual void registerAttributes(){
-			PhysicalActionDamperUnit::registerAttributes();
-			REGISTER_ATTRIBUTE(damping);
-		}
-	NEEDS_BEX(&quot;Force&quot;);
-	FUNCTOR2D(Force,ParticleParameters);
-	REGISTER_CLASS_NAME(CundallNonViscousForceDamping);
-	REGISTER_BASE_CLASS_NAME(PhysicalActionDamperUnit);
+		NEEDS_BEX(&quot;Force&quot;);
+		FUNCTOR2D(Force,ParticleParameters);
+	#endif
+	REGISTER_CLASS_AND_BASE(CundallNonViscousForceDamping,PhysicalActionDamperUnit);
 };
 REGISTER_SERIALIZABLE(CundallNonViscousForceDamping);
 
@@ -23,16 +23,16 @@
 	public:
 		Real damping;
 		CundallNonViscousMomentumDamping(): damping(0){};
+		virtual void registerAttributes(){PhysicalActionDamperUnit::registerAttributes();REGISTER_ATTRIBUTE(damping); }
+	#ifdef BEX_CONTAINER
+		virtual void go(const shared_ptr&lt;PhysicalParameters&gt;&amp;, const Body*, MetaBody*);
+		FUNCTOR1D(RigidBodyParameters);
+	#else
 		virtual void go(const shared_ptr&lt;PhysicalAction&gt;&amp;, const shared_ptr&lt;PhysicalParameters&gt;&amp;, const Body*);
-	protected:
-		 virtual void registerAttributes(){
-			PhysicalActionDamperUnit::registerAttributes();
-			REGISTER_ATTRIBUTE(damping);
-		 }
-	NEEDS_BEX(&quot;Momentum&quot;);
-	FUNCTOR2D(Momentum,RigidBodyParameters);
-	REGISTER_CLASS_NAME(CundallNonViscousMomentumDamping);
-	REGISTER_BASE_CLASS_NAME(PhysicalActionDamperUnit);
+		NEEDS_BEX(&quot;Momentum&quot;);
+		FUNCTOR2D(Momentum,RigidBodyParameters);
+	#endif
+	REGISTER_CLASS_AND_BASE(CundallNonViscousMomentumDamping,PhysicalActionDamperUnit);
 };
 REGISTER_SERIALIZABLE(CundallNonViscousMomentumDamping);
 

Modified: trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -8,43 +8,36 @@
 *  GNU General Public License v2 or later. See file LICENSE for details. *
 *************************************************************************/
 
-#include &quot;NewtonsForceLaw.hpp&quot;
+#include&quot;NewtonsForceLaw.hpp&quot;
 #include&lt;yade/pkg-common/ParticleParameters.hpp&gt;
 #include&lt;yade/pkg-common/RigidBodyParameters.hpp&gt;
 #include&lt;yade/pkg-common/Force.hpp&gt;
+#include&lt;yade/core/MetaBody.hpp&gt;
 
-
+#ifdef BEX_CONTAINER
+void NewtonsForceLaw::go(const shared_ptr&lt;PhysicalParameters&gt;&amp; b, const Body* bb, MetaBody* rb){
+	Vector3r f=rb-&gt;bex.getForce(bb-&gt;getId());
+#else
 void NewtonsForceLaw::go( const shared_ptr&lt;PhysicalAction&gt;&amp; a
 			, const shared_ptr&lt;PhysicalParameters&gt;&amp; b
 			, const Body* bb)
 {
-	Force * af = YADE_CAST&lt;Force*&gt;(a.get());
+	const Vector3r&amp; f = YADE_CAST&lt;Force*&gt;(a.get())-&gt;force;
+#endif
 	ParticleParameters * p = YADE_CAST&lt;ParticleParameters*&gt;(b.get());
 	
-	//FIXME : should be += and we should add an Engine that reset acceleration at the beginning
-	// if another PhysicalAction also acts on acceleration then we are overwritting it here
-	//
-	// currently this is not the case, because there is only one
-	// PhysicalAction that influences acceleration: Force
-	// 
-	// If another PhysicalAction will be added, that works on acceleration,
-	// then above will have to be fixed. And example of such action is: Acceleration
-	//
-	
-
-	// TODO: remove debugging stuff from the following
 	// normal behavior of a standalone particle or a clump itself
-	if (bb-&gt;isStandalone()) p-&gt;acceleration=af-&gt;force/p-&gt;mass;
+	if (bb-&gt;isStandalone()) p-&gt;acceleration=f/p-&gt;mass;
 	else if (bb-&gt;isClump()) {
 		// accel for clump reset in Clump::moveMembers, called by ClumpMemberMover engine
-		p-&gt;acceleration+=af-&gt;force/p-&gt;mass;
+		p-&gt;acceleration+=f/p-&gt;mass;
 	}
 	else{ // force applied to a clump member is applied to clump itself
 		const shared_ptr&lt;Body&gt;&amp; clump(Body::byId(bb-&gt;clumpId));
 		RigidBodyParameters* clumpRBP=YADE_CAST&lt;RigidBodyParameters*&gt;(clump-&gt;physicalParameters.get());
 		// accels reset by Clump::moveMembers in last iteration
-		clumpRBP-&gt;acceleration+=af-&gt;force/clumpRBP-&gt;mass;
-		clumpRBP-&gt;angularAcceleration+=diagDiv((b-&gt;se3.position-clumpRBP-&gt;se3.position).Cross(af-&gt;force),clumpRBP-&gt;inertia); //acceleration from torque generated by the force WRT particle centroid on the clump centroid
+		clumpRBP-&gt;acceleration+=f/clumpRBP-&gt;mass;
+		clumpRBP-&gt;angularAcceleration+=diagDiv((b-&gt;se3.position-clumpRBP-&gt;se3.position).Cross(f),clumpRBP-&gt;inertia); //acceleration from torque generated by the force WRT particle centroid on the clump centroid
 	}
 }
 

Modified: trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/EngineUnit/NewtonsForceLaw.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -10,18 +10,28 @@
 
 #include&lt;yade/pkg-common/PhysicalActionApplierUnit.hpp&gt;
 
-class NewtonsForceLaw : public PhysicalActionApplierUnit
-{
-	public :
-		virtual void go( 	  const shared_ptr&lt;PhysicalAction&gt;&amp;
-					, const shared_ptr&lt;PhysicalParameters&gt;&amp;
-					, const Body*);
-	NEEDS_BEX(&quot;Force&quot;);
-	FUNCTOR2D(Force,ParticleParameters);
-	REGISTER_CLASS_NAME(NewtonsForceLaw);
-	REGISTER_BASE_CLASS_NAME(PhysicalActionApplierUnit);
-};
+#ifdef BEX_CONTAINER
+	class NewtonsForceLaw: public PhysicalActionApplierUnit{
+		public:
+			virtual void go(const shared_ptr&lt;PhysicalParameters&gt;&amp;, const Body*, MetaBody*);
+			FUNCTOR1D(ParticleParameters);
+			REGISTER_CLASS_AND_BASE(NewtonsForceLaw,PhysicalActionApplierUnit);
+	};
 
+#else
+	class NewtonsForceLaw : public PhysicalActionApplierUnit
+	{
+		public :
+			virtual void go( 	  const shared_ptr&lt;PhysicalAction&gt;&amp;
+						, const shared_ptr&lt;PhysicalParameters&gt;&amp;
+						, const Body*);
+		NEEDS_BEX(&quot;Force&quot;);
+		FUNCTOR2D(Force,ParticleParameters);
+		REGISTER_CLASS_NAME(NewtonsForceLaw);
+		REGISTER_BASE_CLASS_NAME(PhysicalActionApplierUnit);
+	};
+#endif
+
 REGISTER_SERIALIZABLE(NewtonsForceLaw);
 
 

Modified: trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.cpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -12,8 +12,27 @@
 #include&lt;yade/pkg-common/RigidBodyParameters.hpp&gt;
 #include&lt;yade/pkg-common/Momentum.hpp&gt;
 #include&lt;yade/lib-base/yadeWm3Extra.hpp&gt;
+#include&lt;yade/core/MetaBody.hpp&gt;
 
-
+#ifdef BEX_CONTAINER
+//! Newtons law for both force and momentum
+void NewtonsMomentumLaw::go(const shared_ptr&lt;PhysicalParameters&gt;&amp; b, const Body* bb, MetaBody* rb){
+	body_id_t id=bb-&gt;getId();
+	Vector3r f=rb-&gt;bex.getForce(id); Vector3r m=rb-&gt;bex.getTorque(id);
+	RigidBodyParameters *rbp = static_cast&lt;RigidBodyParameters*&gt;(b.get());
+	if(bb-&gt;isStandalone()){ rbp-&gt;acceleration=f/rbp-&gt;mass; rbp-&gt;angularAcceleration=diagDiv(m,rbp-&gt;inertia); }
+	else if(bb-&gt;isClump()){ rbp-&gt;acceleration+=f/rbp-&gt;mass; rbp-&gt;angularAcceleration+=diagDiv(m,rbp-&gt;inertia); }
+	else { // isClumpMember()
+		const shared_ptr&lt;Body&gt;&amp; clump(Body::byId(bb-&gt;clumpId));
+		RigidBodyParameters* clumpRBP=YADE_CAST&lt;RigidBodyParameters*&gt;(clump-&gt;physicalParameters.get());
+		// accels reset by Clump::moveMembers in last iteration
+		clumpRBP-&gt;acceleration+=f/clumpRBP-&gt;mass;
+		clumpRBP-&gt;angularAcceleration+=diagDiv((b-&gt;se3.position-clumpRBP-&gt;se3.position).Cross(f),clumpRBP-&gt;inertia); //acceleration from torque generated by the force WRT particle centroid on the clump centroid
+		/* angularAcceleration is reset by ClumpMemberMover engine */
+		clumpRBP-&gt;angularAcceleration+=diagDiv(m,clumpRBP-&gt;inertia);
+	}
+}
+#else
 void NewtonsMomentumLaw::go( 	  const shared_ptr&lt;PhysicalAction&gt;&amp; a
 				, const shared_ptr&lt;PhysicalParameters&gt;&amp; b
 				, const Body* bb)
@@ -31,6 +50,6 @@
 		clumpRBP-&gt;angularAcceleration+=diagDiv(am-&gt;momentum,clumpRBP-&gt;inertia);
 	}
 }
+#endif
 
-
 YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.hpp
===================================================================
--- trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/EngineUnit/NewtonsMomentumLaw.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -9,7 +9,14 @@
 #pragma once
 
 #include&lt;yade/pkg-common/PhysicalActionApplierUnit.hpp&gt;
-
+#ifdef BEX_CONTAINER
+	class NewtonsMomentumLaw: public PhysicalActionApplierUnit{
+		public:
+			virtual void go(const shared_ptr&lt;PhysicalParameters&gt;&amp;, const Body*, MetaBody*);
+			FUNCTOR1D(RigidBodyParameters);
+			REGISTER_CLASS_AND_BASE(NewtonsMomentumLaw,PhysicalActionApplierUnit);
+	};
+#else
 class NewtonsMomentumLaw : public PhysicalActionApplierUnit
 {
 	public :
@@ -22,7 +29,7 @@
 	REGISTER_CLASS_NAME(NewtonsMomentumLaw);
 	REGISTER_BASE_CLASS_NAME(PhysicalActionApplierUnit);
 };
-
+#endif
 REGISTER_SERIALIZABLE(NewtonsMomentumLaw);
 
 

Modified: trunk/pkg/common/Engine/MetaEngine/ConstitutiveLaw.hpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/ConstitutiveLaw.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/MetaEngine/ConstitutiveLaw.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -9,12 +9,16 @@
 class ConstitutiveLaw: public EngineUnit2D &lt;
 		void, TYPELIST_4(shared_ptr&lt;InteractionGeometry&gt;&amp;, shared_ptr&lt;InteractionPhysics&gt;&amp;, Interaction*, MetaBody*)
 	&gt;{
+	#ifndef BEX_CONTAINER
 		int forceIdx, torqueIdx;
+	#endif
 	public:
 		ConstitutiveLaw(){
 			// cache force/torque indices for fast access in bodyForce and bodyTorque
-			forceIdx=shared_ptr&lt;PhysicalAction&gt;(new Force())-&gt;getClassIndex();
-			torqueIdx=shared_ptr&lt;PhysicalAction&gt;(new Momentum())-&gt;getClassIndex();
+			#ifndef BEX_CONTAINER
+				forceIdx=shared_ptr&lt;PhysicalAction&gt;(new Force())-&gt;getClassIndex();
+				torqueIdx=shared_ptr&lt;PhysicalAction&gt;(new Momentum())-&gt;getClassIndex();
+			#endif
 		}
 	REGISTER_CLASS_AND_BASE(ConstitutiveLaw,EngineUnit2D);
 	/*! Convenience functions to get forces/torques quickly.

Modified: trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.cpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -6,23 +6,31 @@
 *  GNU General Public License v2 or later. See file LICENSE for details. *
 *************************************************************************/
 
-#include &quot;PhysicalActionApplier.hpp&quot;
+#include&quot;PhysicalActionApplier.hpp&quot;
 #include&lt;yade/core/MetaBody.hpp&gt;
 
+#ifdef BEX_CONTAINER
+void PhysicalActionApplier::action(MetaBody* ncb){
+	FOREACH(const shared_ptr&lt;Body&gt;&amp; b, *ncb-&gt;bodies){
+		operator()(b-&gt;physicalParameters,b.get(),ncb);
+	}
+}
+#else
 void PhysicalActionApplier::action(MetaBody* ncb)
 {
-	shared_ptr&lt;BodyContainer&gt;&amp; bodies = ncb-&gt;bodies;
+		throw logic_error(&quot;PhysicalActionApplier cannot be used with BexContainer. Use NewtonsDampedLaw instead (or recompile with NO_BEX).&quot;);
+		shared_ptr&lt;BodyContainer&gt;&amp; bodies = ncb-&gt;bodies;
 
-	PhysicalActionContainer::iterator pai    = ncb-&gt;physicalActions-&gt;begin();
-	PhysicalActionContainer::iterator paiEnd = ncb-&gt;physicalActions-&gt;end(); 
-	for( ; pai!=paiEnd ; ++pai)
-	{
-		shared_ptr&lt;PhysicalAction&gt; action = *pai;
-		int id = pai.getCurrentIndex();
-		// FIXME - solve the problem of Body's id
-		operator()( action , (*bodies)[id]-&gt;physicalParameters , (*bodies)[id].get() );
-	}
+		PhysicalActionContainer::iterator pai    = ncb-&gt;physicalActions-&gt;begin();
+		PhysicalActionContainer::iterator paiEnd = ncb-&gt;physicalActions-&gt;end(); 
+		for( ; pai!=paiEnd ; ++pai)
+		{
+			shared_ptr&lt;PhysicalAction&gt; action = *pai;
+			int id = pai.getCurrentIndex();
+			operator()( action , (*bodies)[id]-&gt;physicalParameters , (*bodies)[id].get() );
+		}
 }
+#endif
 
 
 YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.hpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplier.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -12,13 +12,20 @@
 
 
 #include&lt;yade/core/MetaEngine2D.hpp&gt;
+#include&lt;yade/core/MetaEngine1D.hpp&gt;
 #include&lt;yade/lib-multimethods/DynLibDispatcher.hpp&gt;
 #include&lt;yade/core/PhysicalAction.hpp&gt;
 
 #include&lt;yade/pkg-common/PhysicalActionApplierUnit.hpp&gt;
 
 class Body;
-
+#ifdef BEX_CONTAINER
+class PhysicalActionApplier: public MetaEngine1D&lt;PhysicalParameters,PhysicalActionApplierUnit,void,TYPELIST_3(const shared_ptr&lt;PhysicalParameters&gt;&amp;,const Body*, MetaBody*)&gt;{
+	public: virtual void action(MetaBody*);
+	REGISTER_CLASS_AND_BASE(PhysicalActionApplier,MetaEngine1D);
+};
+REGISTER_SERIALIZABLE(PhysicalActionApplier);
+#else
 class PhysicalActionApplier :	public MetaEngine2D
 				&lt;
 					PhysicalAction ,					// base classe for dispatch
@@ -37,7 +44,6 @@
 	REGISTER_CLASS_NAME(PhysicalActionApplier);
 	REGISTER_BASE_CLASS_NAME(MetaEngine2D);
 };
-
 REGISTER_SERIALIZABLE(PhysicalActionApplier);
+#endif
 
-

Modified: trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplierUnit.hpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplierUnit.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/MetaEngine/PhysicalActionApplierUnit.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -12,7 +12,14 @@
 #include&lt;yade/core/PhysicalParameters.hpp&gt;
 #include&lt;yade/core/Body.hpp&gt;
 #include&lt;yade/core/EngineUnit2D.hpp&gt;
+#include&lt;yade/core/EngineUnit1D.hpp&gt;
 
+#ifdef BEX_CONTAINER
+class PhysicalActionApplierUnit: public EngineUnit1D&lt;void,TYPELIST_3(const shared_ptr&lt;PhysicalParameters&gt;&amp;,const Body*, MetaBody*)&gt;{
+	REGISTER_CLASS_AND_BASE(PhysicalActionApplierUnit,EngineUnit1D);
+};
+REGISTER_SERIALIZABLE(PhysicalActionApplierUnit);
+#else
 class PhysicalActionApplierUnit :	public EngineUnit2D
 					&lt;
 		 				void ,
@@ -25,7 +32,6 @@
 	REGISTER_CLASS_NAME(PhysicalActionApplierUnit);
 	REGISTER_BASE_CLASS_NAME(EngineUnit2D);
 };
-
 REGISTER_SERIALIZABLE(PhysicalActionApplierUnit);
+#endif
 
-

Modified: trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.cpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -11,28 +11,27 @@
 #include &quot;PhysicalActionDamper.hpp&quot;
 #include&lt;yade/core/MetaBody.hpp&gt;
 
+#ifdef BEX_CONTAINER
+void PhysicalActionDamper::action(MetaBody* ncb){
+	FOREACH(const shared_ptr&lt;Body&gt;&amp; b, *ncb-&gt;bodies){
+		operator()(b-&gt;physicalParameters,b.get(),ncb);
+	}
+}
+#else
 void PhysicalActionDamper::action(MetaBody* ncb)
 {
-	shared_ptr&lt;BodyContainer&gt;&amp; bodies = ncb-&gt;bodies;
-	PhysicalActionContainer::iterator pai    = ncb-&gt;physicalActions-&gt;begin();
-	PhysicalActionContainer::iterator paiEnd = ncb-&gt;physicalActions-&gt;end();
-	for( ; pai!=paiEnd ; ++pai)
-	{
-		shared_ptr&lt;PhysicalAction&gt; action = *pai;
-		int id = pai.getCurrentIndex();
-		// FIXME - solve the problem of Body's id
-		operator()( action , (*bodies)[id]-&gt;physicalParameters , (*bodies)[id].get() );
-	}
-
-
-//	for( ncb-&gt;physicalActions-&gt;gotoFirst() ; ncb-&gt;physicalActions-&gt;notAtEnd() ; ncb-&gt;physicalActions-&gt;gotoNext())
-//	{
-//		shared_ptr&lt;PhysicalAction&gt;&amp; action = ncb-&gt;physicalActions-&gt;getCurrent(id);
-//		// FIXME - solve the problem of Body's id
-//		operator()( action , (*bodies)[id]-&gt;physicalParameters , (*bodies)[id].get() );
-//	}
-
+		shared_ptr&lt;BodyContainer&gt;&amp; bodies = ncb-&gt;bodies;
+		PhysicalActionContainer::iterator pai    = ncb-&gt;physicalActions-&gt;begin();
+		PhysicalActionContainer::iterator paiEnd = ncb-&gt;physicalActions-&gt;end();
+		for( ; pai!=paiEnd ; ++pai)
+		{
+			shared_ptr&lt;PhysicalAction&gt; action = *pai;
+			int id = pai.getCurrentIndex();
+			// FIXME - solve the problem of Body's id
+			operator()( action , (*bodies)[id]-&gt;physicalParameters , (*bodies)[id].get() );
+		}
 }
+#endif
 
 
 YADE_PLUGIN();

Modified: trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.hpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamper.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -9,30 +9,38 @@
 #pragma once
 
 #include&lt;yade/core/MetaEngine2D.hpp&gt;
+#include&lt;yade/core/MetaEngine1D.hpp&gt;
 #include&lt;yade/lib-multimethods/DynLibDispatcher.hpp&gt;
 #include&lt;yade/core/PhysicalAction.hpp&gt;
 #include&lt;yade/pkg-common/PhysicalActionDamperUnit.hpp&gt;
 
 class Body;
+class MetaBody;
+#ifdef BEX_CONTAINER
+	class PhysicalActionDamper: public MetaEngine1D&lt;PhysicalParameters,PhysicalActionDamperUnit,void,TYPELIST_3(const shared_ptr&lt;PhysicalParameters&gt;&amp;, const Body*, MetaBody*)&gt;{
+		public: virtual void action(MetaBody*);
+		REGISTER_CLASS_AND_BASE(PhysicalActionDamper,MetaEngine1D);
+	};
+	REGISTER_SERIALIZABLE(PhysicalActionDamper);
+#else
+	class PhysicalActionDamper : public MetaEngine2D
+					&lt;	PhysicalAction,						// base classe for dispatch
+						PhysicalParameters,					// base classe for dispatch
+						PhysicalActionDamperUnit,				// class that provides multivirtual call
+						void,							// return type
+						TYPELIST_3(	  const shared_ptr&lt;PhysicalAction&gt;&amp;	// function arguments
+								, const shared_ptr&lt;PhysicalParameters&gt;&amp; 
+								, const Body *
+							  )
+					&gt;
+	{
+		public :
+			virtual void action(MetaBody*);
 
-class PhysicalActionDamper : public MetaEngine2D
-				&lt;	PhysicalAction,						// base classe for dispatch
-					PhysicalParameters,					// base classe for dispatch
-					PhysicalActionDamperUnit,				// class that provides multivirtual call
-					void,							// return type
-					TYPELIST_3(	  const shared_ptr&lt;PhysicalAction&gt;&amp;	// function arguments
-							, const shared_ptr&lt;PhysicalParameters&gt;&amp; 
-							, const Body *
-						  )
-				&gt;
-{
-	public :
-		virtual void action(MetaBody*);
+		REGISTER_CLASS_NAME(PhysicalActionDamper);
+		REGISTER_BASE_CLASS_NAME(MetaEngine2D);
+	};
+	REGISTER_SERIALIZABLE(PhysicalActionDamper);
+#endif
 
-	REGISTER_CLASS_NAME(PhysicalActionDamper);
-	REGISTER_BASE_CLASS_NAME(MetaEngine2D);
-};
 
-REGISTER_SERIALIZABLE(PhysicalActionDamper);
-
-

Modified: trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamperUnit.hpp
===================================================================
--- trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamperUnit.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/MetaEngine/PhysicalActionDamperUnit.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -11,8 +11,19 @@
 #include&lt;yade/core/PhysicalAction.hpp&gt;
 #include&lt;yade/core/PhysicalParameters.hpp&gt;
 #include&lt;yade/core/Body.hpp&gt;
+#include&lt;yade/core/MetaBody.hpp&gt;
 #include&lt;yade/core/EngineUnit2D.hpp&gt;
+#include&lt;yade/core/EngineUnit1D.hpp&gt;
 
+#ifdef BEX_CONTAINER
+class PhysicalActionDamperUnit: public EngineUnit1D&lt;void,TYPELIST_3(const shared_ptr&lt;PhysicalParameters&gt;&amp;,const Body*, MetaBody*)&gt;{
+	REGISTER_CLASS_AND_BASE(PhysicalActionDamperUnit,EngineUnit1D);
+	/* We are friend of BexContainer. These functions can be used safely provided that bex is NEVER read after being modified. */
+	Vector3r getForceUnsynced (body_id_t id, MetaBody* rb){ return rb-&gt;bex.getForceUnsynced (id);}
+	Vector3r getTorqueUnsynced(body_id_t id, MetaBody* rb){ return rb-&gt;bex.getTorqueUnsynced(id);}
+};
+REGISTER_SERIALIZABLE(PhysicalActionDamperUnit);
+#else
 class PhysicalActionDamperUnit : public EngineUnit2D
 				 &lt;
 		 			void ,
@@ -25,6 +36,5 @@
 	REGISTER_CLASS_NAME(PhysicalActionDamperUnit);
 	REGISTER_BASE_CLASS_NAME(EngineUnit2D);
 };
-
 REGISTER_SERIALIZABLE(PhysicalActionDamperUnit);
-
+#endif

Modified: trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerInitializer.cpp
===================================================================
--- trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerInitializer.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/common/Engine/StandAloneEngine/PhysicalActionContainerInitializer.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -32,33 +32,32 @@
 void PhysicalActionContainerInitializer::action(MetaBody* ncb)
 {
 	#ifdef BEX_CONTAINER
-		// this is not necessary, since BexContainer grows upon requests.
+		// this is not necessary, since BexContainer grows upon request.
 		// But it takes about 10 resizes to get to 2000 bodies (only at the beginning), so you can save a few milliseconds here
 		ncb-&gt;bex.resize(ncb-&gt;bodies-&gt;size());
-		return;
-	#endif
-	list&lt;string&gt; allNames;
-	// copy physical action names that were passed by the user directly
-	allNames.insert(allNames.end(),physicalActionNames.begin(),physicalActionNames.end());
-	LOG_DEBUG(&quot;allNames as defined by the user: &quot;);	FOREACH(string an,allNames) LOG_DEBUG(an);
-	// loop over all engines, get Bex from them
-	FOREACH(shared_ptr&lt;Engine&gt; e, ncb-&gt;engines){
-		list&lt;string&gt; bex=e-&gt;getNeededBex();
-		allNames.insert(allNames.end(),bex.begin(),bex.end());
-		LOG_DEBUG(&quot;The following engines were inserted by &quot;&lt;&lt;e-&gt;getClassName()&lt;&lt;&quot;:&quot;); FOREACH(string b,bex) LOG_DEBUG(b);
-	}
-	LOG_DEBUG(&quot;allNames after loop over engines: &quot;);	FOREACH(string an,allNames) LOG_DEBUG(an);
-	// eliminate all duplicates
-	allNames.sort();
-	allNames.unique();
-	LOG_DEBUG(&quot;allNames after sort and unique: &quot;);	FOREACH(string an,allNames) LOG_DEBUG(an);
+	#else
+		list&lt;string&gt; allNames;
+		// copy physical action names that were passed by the user directly
+		allNames.insert(allNames.end(),physicalActionNames.begin(),physicalActionNames.end());
+		LOG_DEBUG(&quot;allNames as defined by the user: &quot;);	FOREACH(string an,allNames) LOG_DEBUG(an);
+		// loop over all engines, get Bex from them
+		FOREACH(shared_ptr&lt;Engine&gt; e, ncb-&gt;engines){
+			list&lt;string&gt; bex=e-&gt;getNeededBex();
+			allNames.insert(allNames.end(),bex.begin(),bex.end());
+			LOG_DEBUG(&quot;The following engines were inserted by &quot;&lt;&lt;e-&gt;getClassName()&lt;&lt;&quot;:&quot;); FOREACH(string b,bex) LOG_DEBUG(b);
+		}
+		LOG_DEBUG(&quot;allNames after loop over engines: &quot;);	FOREACH(string an,allNames) LOG_DEBUG(an);
+		// eliminate all duplicates
+		allNames.sort();
+		allNames.unique();
+		LOG_DEBUG(&quot;allNames after sort and unique: &quot;);	FOREACH(string an,allNames) LOG_DEBUG(an);
 
-	vector&lt;shared_ptr&lt;PhysicalAction&gt; &gt; physicalActions;
-	FOREACH(string physicalActionName, allNames){
-		physicalActions.push_back(YADE_PTR_CAST&lt;PhysicalAction&gt;(ClassFactory::instance().createShared(physicalActionName)));
-	}
-	ncb-&gt;physicalActions-&gt;prepare(physicalActions);
-	
+		vector&lt;shared_ptr&lt;PhysicalAction&gt; &gt; physicalActions;
+		FOREACH(string physicalActionName, allNames){
+			physicalActions.push_back(YADE_PTR_CAST&lt;PhysicalAction&gt;(ClassFactory::instance().createShared(physicalActionName)));
+		}
+		ncb-&gt;physicalActions-&gt;prepare(physicalActions);
+	#endif
 }
 
 

Modified: trunk/pkg/dem/Engine/DeusExMachina/CapillaryRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/CapillaryRecorder.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/DeusExMachina/CapillaryRecorder.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -53,9 +53,13 @@
 {
 	Real fx=0, fy=0, fz=0;
 	
+	#ifdef BEX_CONTAINER
+		ncb-&gt;bex.sync();
+		Vector3r force=ncb-&gt;bex.getForce(bigBallId);
+	#else
+		Vector3r force = static_cast&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find(bigBallId, actionForce-&gt;getClassIndex() ) . get() )-&gt;force;
+	#endif
 	
-	Vector3r force = static_cast&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find(
-bigBallId, actionForce-&gt;getClassIndex() ) . get() )-&gt;force;
 		
 		fx=force[0];
 		fy=force[1];

Modified: trunk/pkg/dem/Engine/DeusExMachina/HydraulicForceEngine.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/HydraulicForceEngine.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/DeusExMachina/HydraulicForceEngine.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -73,7 +73,11 @@
                     //cerr &lt;&lt; &quot;translate it&quot; &lt;&lt; endl;
                     if ((static_cast&lt;CohesiveFrictionalBodyParameters*&gt; (b-&gt;physicalParameters.get()))-&gt;isBroken == true)
                     {
-                        static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find( b-&gt;getId() , actionParameterForce-&gt;getClassIndex() ).get() )-&gt;force += Vector3r(0,5,0);
+                        #ifdef BEX_CONTAINER
+									ncb-&gt;bex.addForce(b-&gt;getId(),Vector3r(0,5,0));
+								#else
+									static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find( b-&gt;getId() , actionParameterForce-&gt;getClassIndex() ).get() )-&gt;force += Vector3r(0,5,0);
+								#endif
                     }
                     // else  b-&gt;geometricalModel-&gt;diffuseColor= Vector3r(0.5,0.9,0.3);
                 }
@@ -99,9 +103,14 @@
                     Vector3r t (mx,my,mz);
                     //f /= -10000;
                     //t *= 0;
-                    static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find( id , actionParameterForce-&gt;getClassIndex() ).get() )-&gt;force += f;
-                    //cerr &lt;&lt; &quot;added force = &quot; &lt;&lt; f &lt;&lt; endl;
-                    static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id , actionParameterMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += t;
+						  #ifdef BEX_CONTAINER
+						  		ncb-&gt;bex.addForce(id,f);
+								ncb-&gt;bex.addTorque(id,t);
+						  #else
+	                    static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find( id , actionParameterForce-&gt;getClassIndex() ).get() )-&gt;force += f;
+	                    //cerr &lt;&lt; &quot;added force = &quot; &lt;&lt; f &lt;&lt; endl;
+	                    static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id , actionParameterMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += t;
+						  #endif
 
                 }
             }

Modified: trunk/pkg/dem/Engine/DeusExMachina/MakeItFlat.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/MakeItFlat.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/DeusExMachina/MakeItFlat.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -56,7 +56,11 @@
 			{
 				p-&gt;se3.position[direction]=plane_position;
 				if(reset_force)
-					static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find( b-&gt;getId() , actionParameterForce-&gt;getClassIndex() ).get() )-&gt;force[direction]=0;// 
+					#ifdef BEX_CONTAINER
+						throw runtime_error(&quot;BexContainer doesn't work with MakeIfFlat resetting forces, since it would have to sync() frequently. Use PhysicalParameters::blockedDOFs instead, MakeItFlat will be removed.&quot;);
+					#else
+						static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find( b-&gt;getId() , actionParameterForce-&gt;getClassIndex() ).get() )-&gt;force[direction]=0;// 
+					#endif
 			}
 		}
 	}

Modified: trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -7,91 +7,94 @@
 *  This program is free software; it is licensed under the terms of the  *
 *  GNU General Public License v2 or later. See file LICENSE for details. *
 *************************************************************************/
+#include&quot;ResultantForceEngine.hpp&quot;
 
+#ifndef BEX_CONTAINER
 
-#include&quot;ResultantForceEngine.hpp&quot;
-#include&lt;yade/pkg-common/ParticleParameters.hpp&gt;
-#include&lt;yade/pkg-common/Force.hpp&gt;
-#include&lt;yade/pkg-dem/GlobalStiffness.hpp&gt;
-#include&lt;Wm3Math.h&gt;
-#include&lt;yade/lib-base/yadeWm3.hpp&gt;
-#include&lt;yade/lib-base/yadeWm3Extra.hpp&gt;
+	#include&lt;yade/pkg-common/ParticleParameters.hpp&gt;
+	#include&lt;yade/pkg-common/Force.hpp&gt;
+	#include&lt;yade/pkg-dem/GlobalStiffness.hpp&gt;
+	#include&lt;Wm3Math.h&gt;
+	#include&lt;yade/lib-base/yadeWm3.hpp&gt;
+	#include&lt;yade/lib-base/yadeWm3Extra.hpp&gt;
 
 
 
-#include&lt;yade/core/MetaBody.hpp&gt;
+	#include&lt;yade/core/MetaBody.hpp&gt;
 
 
-ResultantForceEngine::ResultantForceEngine() : actionParameterGlobalStiffness(new GlobalStiffness), actionParameterForce(new Force)
-{
-	interval =1;
-	damping = 0.1;
-	force = Vector3r::ZERO;
-	previoustranslation = Vector3r::ZERO;
-	stiffness = Vector3r::ZERO;
-	max_vel = 0.001;
-}
+	ResultantForceEngine::ResultantForceEngine() : actionParameterGlobalStiffness(new GlobalStiffness), actionParameterForce(new Force)
+	{
+		interval =1;
+		damping = 0.1;
+		force = Vector3r::ZERO;
+		previoustranslation = Vector3r::ZERO;
+		stiffness = Vector3r::ZERO;
+		max_vel = 0.001;
+	}
 
-ResultantForceEngine::~ResultantForceEngine()
-{
-}
+	ResultantForceEngine::~ResultantForceEngine()
+	{
+	}
 
 
-void ResultantForceEngine::registerAttributes()
-{
-	DeusExMachina::registerAttributes();
-	REGISTER_ATTRIBUTE(interval);
-	REGISTER_ATTRIBUTE(damping);
-	REGISTER_ATTRIBUTE(force);
-	REGISTER_ATTRIBUTE(previoustranslation);
-	REGISTER_ATTRIBUTE(stiffness);
-	REGISTER_ATTRIBUTE(max_vel);
-}
+	void ResultantForceEngine::registerAttributes()
+	{
+		DeusExMachina::registerAttributes();
+		REGISTER_ATTRIBUTE(interval);
+		REGISTER_ATTRIBUTE(damping);
+		REGISTER_ATTRIBUTE(force);
+		REGISTER_ATTRIBUTE(previoustranslation);
+		REGISTER_ATTRIBUTE(stiffness);
+		REGISTER_ATTRIBUTE(max_vel);
+	}
 
 
 
-void ResultantForceEngine::applyCondition(MetaBody* ncb)
-{
-	//cerr &lt;&lt; &quot;void ResultantForceEngine::applyCondition(Body* body)&quot; &lt;&lt; std::endl;
-	shared_ptr&lt;BodyContainer&gt;&amp; bodies = ncb-&gt;bodies;
-	
-	std::vector&lt;int&gt;::const_iterator ii = subscribedBodies.begin();
-	std::vector&lt;int&gt;::const_iterator iiEnd = subscribedBodies.end();
-	
-	//cerr &lt;&lt; &quot;std::vector&lt;int&gt;::const_iterator iiEnd = subscribedBodies.end();&quot; &lt;&lt; Omega::instance().getCurrentIteration() &lt;&lt; std::endl;
-	
-	
-	
-	for(;ii!=iiEnd;++ii)
+	void ResultantForceEngine::applyCondition(MetaBody* ncb)
 	{
-	//cerr &lt;&lt; &quot;for(;ii!=iiEnd;++ii)&quot; &lt;&lt; std::endl;
-	//if( bodies-&gt;exists(*ii) ) 
-	//{
-		//Update stiffness only if it has been computed by StiffnessCounter (see &quot;interval&quot;)
-		if (Omega::instance().getCurrentIteration() % interval == 0)	stiffness =
-		(static_cast&lt;GlobalStiffness*&gt;( ncb-&gt;physicalActions-&gt;find (*ii, actionParameterGlobalStiffness-&gt;getClassIndex() ).get() ))-&gt;stiffness;
-	
-		//cerr &lt;&lt; &quot;static_cast&lt;GlobalStiffness*&gt;( ncb-&gt;physicalActions-&gt;find (*ii, actionParameterGlobalStiffness-&gt;getClassIndex() ).get() ))-&gt;stiffness&quot; &lt;&lt; std::endl;
+		//cerr &lt;&lt; &quot;void ResultantForceEngine::applyCondition(Body* body)&quot; &lt;&lt; std::endl;
+		shared_ptr&lt;BodyContainer&gt;&amp; bodies = ncb-&gt;bodies;
 		
-		if(PhysicalParameters* p = dynamic_cast&lt;PhysicalParameters*&gt;((*bodies)[*ii]-&gt;physicalParameters.get()))
+		std::vector&lt;int&gt;::const_iterator ii = subscribedBodies.begin();
+		std::vector&lt;int&gt;::const_iterator iiEnd = subscribedBodies.end();
+		
+		//cerr &lt;&lt; &quot;std::vector&lt;int&gt;::const_iterator iiEnd = subscribedBodies.end();&quot; &lt;&lt; Omega::instance().getCurrentIteration() &lt;&lt; std::endl;
+		
+		
+		
+		for(;ii!=iiEnd;++ii)
 		{
-			//cerr &lt;&lt; &quot;dynamic_cast&lt;PhysicalParameters*&gt;((*bodies)[*ii]-&gt;physicalParameters.get()&quot; &lt;&lt; std::endl;
-//			GlobalStiffness* sm = static_cast&lt;GlobalStiffness*&gt;( ncb-&gt;physicalActions-&gt;find (*ii, actionParameterGlobalStiffness-&gt;getClassIndex() ).get() );
+		//cerr &lt;&lt; &quot;for(;ii!=iiEnd;++ii)&quot; &lt;&lt; std::endl;
+		//if( bodies-&gt;exists(*ii) ) 
+		//{
+			//Update stiffness only if it has been computed by StiffnessCounter (see &quot;interval&quot;)
+			if (Omega::instance().getCurrentIteration() % interval == 0)	stiffness =
+			(static_cast&lt;GlobalStiffness*&gt;( ncb-&gt;physicalActions-&gt;find (*ii, actionParameterGlobalStiffness-&gt;getClassIndex() ).get() ))-&gt;stiffness;
+		
+			//cerr &lt;&lt; &quot;static_cast&lt;GlobalStiffness*&gt;( ncb-&gt;physicalActions-&gt;find (*ii, actionParameterGlobalStiffness-&gt;getClassIndex() ).get() ))-&gt;stiffness&quot; &lt;&lt; std::endl;
 			
-			Vector3r effectiveforce =
-			 	static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find( *ii,actionParameterForce-&gt;getClassIndex() ).get() )-&gt;force; 
-			Vector3r deltaf (effectiveforce - force);
-			Vector3r translation 
-				(stiffness.X()==0 ? Mathr::Sign(deltaf.X())*max_vel : Mathr::Sign(deltaf.X())*std::min( abs(deltaf.X()/stiffness.X()), max_vel),
-				stiffness.Y()==0 ? Mathr::Sign(deltaf.Y())*max_vel : Mathr::Sign(deltaf.Y())*std::min( abs(deltaf.Y()/stiffness.Y()), max_vel),
-				stiffness.Z()==0 ? Mathr::Sign(deltaf.Z())*max_vel : Mathr::Sign(deltaf.Z())*std::min( abs(deltaf.Z()/stiffness.Z()), max_vel) );
-			previoustranslation = (1-damping)*translation + 0.9*previoustranslation;// formula for &quot;steady-flow&quot; evolution with fluctuations
-			p-&gt;se3.position	+= previoustranslation;
-			//p-&gt;velocity		=  previoustranslation/dt;//FIXME : useless???	
-		}		
-	//}
+			if(PhysicalParameters* p = dynamic_cast&lt;PhysicalParameters*&gt;((*bodies)[*ii]-&gt;physicalParameters.get()))
+			{
+				//cerr &lt;&lt; &quot;dynamic_cast&lt;PhysicalParameters*&gt;((*bodies)[*ii]-&gt;physicalParameters.get()&quot; &lt;&lt; std::endl;
+	//			GlobalStiffness* sm = static_cast&lt;GlobalStiffness*&gt;( ncb-&gt;physicalActions-&gt;find (*ii, actionParameterGlobalStiffness-&gt;getClassIndex() ).get() );
+				
+				Vector3r effectiveforce =
+					static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find( *ii,actionParameterForce-&gt;getClassIndex() ).get() )-&gt;force; 
+				Vector3r deltaf (effectiveforce - force);
+				Vector3r translation 
+					(stiffness.X()==0 ? Mathr::Sign(deltaf.X())*max_vel : Mathr::Sign(deltaf.X())*std::min( abs(deltaf.X()/stiffness.X()), max_vel),
+					stiffness.Y()==0 ? Mathr::Sign(deltaf.Y())*max_vel : Mathr::Sign(deltaf.Y())*std::min( abs(deltaf.Y()/stiffness.Y()), max_vel),
+					stiffness.Z()==0 ? Mathr::Sign(deltaf.Z())*max_vel : Mathr::Sign(deltaf.Z())*std::min( abs(deltaf.Z()/stiffness.Z()), max_vel) );
+				previoustranslation = (1-damping)*translation + 0.9*previoustranslation;// formula for &quot;steady-flow&quot; evolution with fluctuations
+				p-&gt;se3.position	+= previoustranslation;
+				//p-&gt;velocity		=  previoustranslation/dt;//FIXME : useless???	
+			}		
+		//}
+		}
 	}
-}
 
 
-YADE_PLUGIN();
+	YADE_PLUGIN();
+
+#endif

Modified: trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.hpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/DeusExMachina/ResultantForceEngine.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -9,49 +9,45 @@
 *************************************************************************/
 
 #pragma once
-
 #include&lt;yade/core/DeusExMachina.hpp&gt;
-#include &lt;Wm3Math.h&gt;
-#include&lt;yade/lib-base/yadeWm3.hpp&gt;
-#include &lt;Wm3Vector3.h&gt;
-#include&lt;yade/lib-base/yadeWm3.hpp&gt;
+#ifndef BEX_CONTAINER
 
-class PhysicalAction;
+	class PhysicalAction;
 
-class ResultantForceEngine : public DeusExMachina 
-{
-	private :
-		shared_ptr&lt;PhysicalAction&gt; actionParameterGlobalStiffness;
-		shared_ptr&lt;PhysicalAction&gt; actionParameterForce;
-		
+	class ResultantForceEngine : public DeusExMachina 
+	{
+		private :
+			shared_ptr&lt;PhysicalAction&gt; actionParameterGlobalStiffness;
+			shared_ptr&lt;PhysicalAction&gt; actionParameterForce;
 			
-	public :
-		//! CAUTION : interval must be equal to the interval of the StiffnessCounter, it is used here to check if stiffness has been computed 
-		unsigned int interval;
-		//! Defines the prescibed resultant force 
-		Vector3r		force;	
-		//! Stores the value of the translation at the previous time step
-		Vector3r 		previoustranslation;
-		//! The value of stiffness (updated according to interval) 
-		Vector3r		stiffness;
-		//! damping coefficient - damping=1 implies a &quot;perfect&quot; control of the resultant force
-		Real			damping;
-		//! maximum velocity (usefull to prevent explosions when stiffness is very low...) 
-		Real			max_vel;
+				
+		public :
+			//! CAUTION : interval must be equal to the interval of the StiffnessCounter, it is used here to check if stiffness has been computed 
+			unsigned int interval;
+			//! Defines the prescibed resultant force 
+			Vector3r		force;	
+			//! Stores the value of the translation at the previous time step
+			Vector3r 		previoustranslation;
+			//! The value of stiffness (updated according to interval) 
+			Vector3r		stiffness;
+			//! damping coefficient - damping=1 implies a &quot;perfect&quot; control of the resultant force
+			Real			damping;
+			//! maximum velocity (usefull to prevent explosions when stiffness is very low...) 
+			Real			max_vel;
 
-		ResultantForceEngine();
-		virtual ~ResultantForceEngine();
-	
-		virtual void applyCondition(MetaBody*);
+			ResultantForceEngine();
+			virtual ~ResultantForceEngine();
 		
-	
-	protected :
-		virtual void registerAttributes();
-	NEEDS_BEX(&quot;Force&quot;,&quot;GlobalStiffness&quot;);
-	REGISTER_CLASS_NAME(ResultantForceEngine);
-	REGISTER_BASE_CLASS_NAME(DeusExMachina);
-};
+			virtual void applyCondition(MetaBody*);
+			
+		
+		protected :
+			virtual void registerAttributes();
+		NEEDS_BEX(&quot;Force&quot;,&quot;GlobalStiffness&quot;);
+		REGISTER_CLASS_NAME(ResultantForceEngine);
+		REGISTER_BASE_CLASS_NAME(DeusExMachina);
+	};
 
-REGISTER_SERIALIZABLE(ResultantForceEngine);
+	REGISTER_SERIALIZABLE(ResultantForceEngine);
+#endif
 
-

Modified: trunk/pkg/dem/Engine/DeusExMachina/TriaxialStressController.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/TriaxialStressController.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/DeusExMachina/TriaxialStressController.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -329,25 +329,7 @@
 	force[wall_front]= getForce(ncb,wall_id[wall_front]);  stress[wall_front]= force[wall_front] *invZSurface;
 	force[wall_back]=  getForce(ncb,wall_id[wall_back]);   stress[wall_back]=  force[wall_back]  *invZSurface;
 
-// remove this, it is in the 6 lines above now
-#if 0	
-	stress[wall_bottom] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_bottom],ForceClassIndex).get() )-&gt;force ) * invYSurface;
-	stress[wall_top] = static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_top],ForceClassIndex).get() )-&gt;force * invYSurface;
-	stress[wall_left] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_left],ForceClassIndex).get() )-&gt;force ) * invXSurface;
-	stress[wall_right] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_right],ForceClassIndex).get() )-&gt;force ) * invXSurface;
-	stress[wall_front] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_front],ForceClassIndex).get() )-&gt;force ) * invZSurface;
-	stress[wall_back] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_back],ForceClassIndex).get() )-&gt;force ) * invZSurface;	
 
-// ==================================================== jf
-	force[wall_bottom] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_bottom],ForceClassIndex).get() )-&gt;force );
-	force[wall_top] = static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_top],ForceClassIndex).get() )-&gt;force ;
-	force[wall_left] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_left],ForceClassIndex).get() )-&gt;force ) ;
-	force[wall_right] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_right],ForceClassIndex).get() )-&gt;force ) ;
-	force[wall_front] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_front],ForceClassIndex).get() )-&gt;force ) ;
-	force[wall_back] = ( static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_id[wall_back],ForceClassIndex).get() )-&gt;force ) ;	
-// ====================================================
-#endif
-
  	//cerr &lt;&lt; &quot;stresses : &quot; &lt;&lt;  stress[wall_bottom] &lt;&lt; &quot; &quot; &lt;&lt;
  //stress[wall_top]&lt;&lt; &quot; &quot; &lt;&lt; stress[wall_left]&lt;&lt; &quot; &quot; &lt;&lt; stress[wall_right]&lt;&lt; &quot; &quot;
  //&lt;&lt; stress[wall_front] &lt;&lt; &quot; &quot; &lt;&lt; stress[wall_back] &lt;&lt; endl;

Modified: trunk/pkg/dem/Engine/DeusExMachina/WallStressRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/DeusExMachina/WallStressRecorder.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/DeusExMachina/WallStressRecorder.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -91,17 +91,19 @@
 	/// calcul des contraintes via forces resultantes sur murs
 	
 	Real SIG_wall_11 = 0, SIG_wall_22 = 0, SIG_wall_33 = 0;
+	#ifdef BEX_CONTAINER
+		ncb-&gt;bex.sync();
+		Vector3r F_wall_11=ncb-&gt;bex.getForce(wall_left_id);
+		Vector3r F_wall_22=ncb-&gt;bex.getForce(wall_top_id);
+		Vector3r F_wall_33=ncb-&gt;bex.getForce(wall_front_id);
+	#else
+		Vector3r F_wall_11 = static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_left_id, actionForce-&gt;getClassIndex() ). get() )-&gt;force;
+		Vector3r F_wall_22 = static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_top_id, actionForce-&gt;getClassIndex() ). get() )-&gt;force;
+		Vector3r F_wall_33 = static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_front_id, actionForce-&gt;getClassIndex() ). get() )-&gt;force;
+	#endif
 	
-	Vector3r F_wall_11 = static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_left_id, actionForce-&gt;getClassIndex() ). get() )-&gt;force;
-	
 	SIG_wall_11 = F_wall_11[0]/(depth*height);
-	
-	Vector3r F_wall_22 = static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_top_id, actionForce-&gt;getClassIndex() ). get() )-&gt;force;
-	
 	SIG_wall_22 = F_wall_22[1]/(depth*width);
-	
-	Vector3r F_wall_33 = static_cast&lt;Force*&gt;( ncb-&gt;physicalActions-&gt;find(wall_front_id, actionForce-&gt;getClassIndex() ). get() )-&gt;force;
-	
 	SIG_wall_33 = F_wall_33[2]/(width*height);
 	
 	ofile &lt;&lt; lexical_cast&lt;string&gt;(Omega::instance().getSimulationTime()) &lt;&lt; &quot; &quot; 

Modified: trunk/pkg/dem/Engine/StandAloneEngine/CapillaryCohesiveLaw.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/CapillaryCohesiveLaw.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/StandAloneEngine/CapillaryCohesiveLaw.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -291,8 +291,13 @@
 					else if (currentContactPhysics-&gt;fusionNumber !=0)
 						currentContactPhysics-&gt;Fcap /= (currentContactPhysics-&gt;fusionNumber+1);
                                 }
-                                static_cast&lt;Force*&gt;   (ncb-&gt;physicalActions-&gt;find( (*ii)-&gt;getId1() , actionForce  -&gt;getClassIndex()).get())-&gt;force    += currentContactPhysics-&gt;Fcap;
-                                static_cast&lt;Force*&gt;   (ncb-&gt;physicalActions-&gt;find( (*ii)-&gt;getId2() , actionForce  -&gt;getClassIndex()).get())-&gt;force    -= currentContactPhysics-&gt;Fcap;
+											#ifdef BEX_CONTAINER
+												ncb-&gt;bex.addForce((*ii)-&gt;getId1(), currentContactPhysics-&gt;Fcap);
+												ncb-&gt;bex.addForce((*ii)-&gt;getId2(),-currentContactPhysics-&gt;Fcap);
+											#else
+	                                static_cast&lt;Force*&gt;   (ncb-&gt;physicalActions-&gt;find( (*ii)-&gt;getId1() , actionForce  -&gt;getClassIndex()).get())-&gt;force    += currentContactPhysics-&gt;Fcap;
+	                                static_cast&lt;Force*&gt;   (ncb-&gt;physicalActions-&gt;find( (*ii)-&gt;getId2() , actionForce  -&gt;getClassIndex()).get())-&gt;force    -= currentContactPhysics-&gt;Fcap;
+											#endif
 
 				//cerr &lt;&lt; &quot;id1/id2 &quot; &lt;&lt; (*ii)-&gt;getId1() &lt;&lt; &quot;/&quot; &lt;&lt; (*ii)-&gt;getId2() &lt;&lt; &quot; Fcap= &quot; &lt;&lt; currentContactPhysics-&gt;Fcap &lt;&lt; endl;
 

Modified: trunk/pkg/dem/Engine/StandAloneEngine/CohesiveFrictionalContactLaw.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/CohesiveFrictionalContactLaw.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/StandAloneEngine/CohesiveFrictionalContactLaw.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -255,11 +255,17 @@
                 //  cerr &lt;&lt; &quot;shearForce &quot; &lt;&lt; shearForce &lt;&lt; endl;
                 // cerr &lt;&lt; &quot;f= &quot; &lt;&lt; f &lt;&lt; endl;
                 // it will be some macro(	body-&gt;physicalActions,	ActionType , bodyId )
+					#ifdef BEX_CONTAINER
+						ncb-&gt;bex.addForce (id1, f);
+						ncb-&gt;bex.addForce (id2,-f);
+						ncb-&gt;bex.addTorque(id1, c1x.Cross(f));
+						ncb-&gt;bex.addTorque(id2,-c2x.Cross(f));
+					#else
                 static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= f;
                 static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += f;
-
                 static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= c1x.Cross(f);
                 static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += c2x.Cross(f);
+					#endif
 
 /////	/// Moment law					 	 ///
 /////		if(momentRotationLaw /*&amp;&amp; currentContactPhysics-&gt;cohesionBroken == false*/ )
@@ -358,9 +364,13 @@
 	Vector3r moment = moment_twist + moment_bending;
 currentContactPhysics-&gt;moment_twist = moment_twist;
 currentContactPhysics-&gt;moment_bending = moment_bending;
-
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= moment;
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += moment;
+			#ifdef BEX_CONTAINER
+				ncb-&gt;bex.addTorque(id1,-moment);
+				ncb-&gt;bex.addTorque(id2, moment);
+			#else
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= moment;
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += moment;
+			#endif
 		}
 	/// Moment law	END				 	 ///
 

Modified: trunk/pkg/dem/Engine/StandAloneEngine/ContactLaw1.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/ContactLaw1.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/StandAloneEngine/ContactLaw1.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -214,12 +214,18 @@
                 //  cerr &lt;&lt; &quot;shearForce &quot; &lt;&lt; shearForce &lt;&lt; endl;
                 // cerr &lt;&lt; &quot;f= &quot; &lt;&lt; f &lt;&lt; endl;
                 // it will be some macro(	body-&gt;physicalActions,	ActionType , bodyId )
-                static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= f;
-                static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += f;
+					#ifdef BEX_CONTAINER
+						ncb-&gt;bex.addForce (id1,-f);
+						ncb-&gt;bex.addForce (id2,+f);
+						ncb-&gt;bex.addTorque(id1,-c1x.Cross(f));
+						ncb-&gt;bex.addTorque(id2, c2x.Cross(f));
+					#else
+	               static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= f;
+   	            static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += f;
+      	         static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= c1x.Cross(f);
+         	      static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += c2x.Cross(f);
+					#endif
 
-                static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= c1x.Cross(f);
-                static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += c2x.Cross(f);
-
 /////	/// Moment law					 	 ///
 /////		if(momentRotationLaw /*&amp;&amp; currentContactPhysics-&gt;cohesionBroken == false*/ )
 /////		{	
@@ -307,9 +313,13 @@
 					nbreInteracMomPlastif++;
 					}
 			}
-
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= moment;
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += moment;
+			#ifdef BEX_CONTAINER
+				ncb-&gt;bex.addTorque(id1,-moment);
+				ncb-&gt;bex.addTorque(id2,+moment);
+			#else
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= moment;
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += moment;
+			#endif
 		}
 	/// Moment law	END				 	 ///
 

Modified: trunk/pkg/dem/Engine/StandAloneEngine/ElasticCohesiveLaw.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/ElasticCohesiveLaw.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/StandAloneEngine/ElasticCohesiveLaw.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -113,15 +113,20 @@
 			currentContactPhysics-&gt;shearForce      -= currentContactPhysics-&gt;ks*shearDisplacement;
 	
 			Vector3r f = currentContactPhysics-&gt;normalForce + currentContactPhysics-&gt;shearForce;
+			#ifdef BEX_CONTAINER
+				ncb-&gt;bex.addForce (id1,-f);
+				ncb-&gt;bex.addForce (id2,+f);
+				ncb-&gt;bex.addTorque(id1,-c1x.Cross(f));
+				ncb-&gt;bex.addTorque(id2, c2x.Cross(f));
+			#else
+				static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= f;
+				static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += f;
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= c1x.Cross(f);
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += c2x.Cross(f);
+			#endif
 	
-			static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= f;
-			static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += f;
-			
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= c1x.Cross(f);
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += c2x.Cross(f);
 	
 	
-	
 	/// Moment law					 	 ///
 		if(momentRotationLaw)
 		{
@@ -214,8 +219,13 @@
 	
 			//if (normElastic&lt;=normMPlastic)
 			//{
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= q_n_i*mElastic;
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += q_n_i*mElastic;
+			#ifdef BEX_CONTAINER
+				ncb-&gt;bex.addTorque(id1,-q_n_i*mElastic);
+				ncb-&gt;bex.addTorque(id2, q_n_i*mElastic);
+			#else
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= q_n_i*mElastic;
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += q_n_i*mElastic;
+			#endif
 	
 			//}  
 			//else

Modified: trunk/pkg/dem/Engine/StandAloneEngine/ForceRecorder.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/ForceRecorder.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/StandAloneEngine/ForceRecorder.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -69,6 +69,9 @@
 void ForceRecorder::action(MetaBody * ncb)
 {
 	if (first) init();
+	#ifdef BEX_CONTAINER
+		ncb-&gt;bex.sync();
+	#endif
 
 	Real x=0, y=0, z=0;
 	
@@ -76,7 +79,11 @@
 	{
 		if(ncb-&gt;bodies-&gt;exists(i))
 		{
-			Vector3r force = YADE_CAST&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find( i , actionForce-&gt;getClassIndex() ) . get() )-&gt;force;
+			#ifdef BEX_CONTAINER
+				Vector3r force=ncb-&gt;bex.getForce(i);
+			#else
+				Vector3r force = YADE_CAST&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find( i , actionForce-&gt;getClassIndex() ) . get() )-&gt;force;
+			#endif
 		
 			x+=force[0];
 			y+=force[1];

Modified: trunk/pkg/dem/Engine/StandAloneEngine/GeometricalModelForceColorizer.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/GeometricalModelForceColorizer.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/StandAloneEngine/GeometricalModelForceColorizer.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -31,6 +31,9 @@
 void GeometricalModelForceColorizer::action(MetaBody * ncb)
 {
 	// FIXME the same in GLDrawLatticeBeamState.cpp
+	#ifdef BEX_CONTAINER
+		ncb-&gt;bex.sync();
+	#endif
 
 	BodyContainer* bodies = ncb-&gt;bodies.get();
 	
@@ -44,7 +47,11 @@
 		if(body-&gt;isDynamic)
 		{
 			unsigned int i = body -&gt; getId();
-			Vector3r force = YADE_CAST&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find( i , actionForce-&gt;getClassIndex() ) . get() )-&gt;force;
+			#ifdef BEX_CONTAINER
+				Vector3r force=ncb-&gt;bex.getForce(i);
+			#else
+				Vector3r force = YADE_CAST&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find( i , actionForce-&gt;getClassIndex() ) . get() )-&gt;force;
+			#endif
 			min = std::min( force[0] , std::min( force[1] , std::min( force[2], min ) ) );
 			max = std::max( force[0] , std::max( force[1] , std::max( force[2], max ) ) );
 		}
@@ -60,7 +67,11 @@
 		{
 			GeometricalModel* gm = body-&gt;geometricalModel.get();
 			unsigned int i = body -&gt; getId();
-			Vector3r force = YADE_CAST&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find( i , actionForce-&gt;getClassIndex() ) . get() )-&gt;force;
+			#ifdef BEX_CONTAINER
+				Vector3r force=ncb-&gt;bex.getForce(i);
+			#else
+				Vector3r force = YADE_CAST&lt;Force*&gt;(ncb-&gt;physicalActions-&gt;find( i , actionForce-&gt;getClassIndex() ) . get() )-&gt;force;
+			#endif
 
 			gm-&gt;diffuseColor[0] = (force[2]-min)/(max-min);
 			gm-&gt;diffuseColor[1] = (force[2]-min)/(max-min);

Modified: trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/StandAloneEngine/GlobalStiffnessCounter.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -56,49 +56,50 @@
 void GlobalStiffnessCounter::traverseInteractions(MetaBody* ncb, const shared_ptr&lt;InteractionContainer&gt;&amp; interactions){
 	#ifdef BEX_CONTAINER
 		return;
-	#endif
-	FOREACH(const shared_ptr&lt;Interaction&gt;&amp; contact, *interactions){
-		if(!contact-&gt;isReal) continue;
+	#else
+		FOREACH(const shared_ptr&lt;Interaction&gt;&amp; contact, *interactions){
+			if(!contact-&gt;isReal) continue;
 
-		SpheresContactGeometry* geom=YADE_CAST&lt;SpheresContactGeometry*&gt;(contact-&gt;interactionGeometry.get()); assert(geom);
-		NormalShearInteraction* phys=YADE_CAST&lt;NormalShearInteraction*&gt;(contact-&gt;interactionPhysics.get()); assert(phys);
-		// all we need for getting stiffness
-		Vector3r&amp; normal=geom-&gt;normal; Real&amp; kn=phys-&gt;kn; Real&amp; ks=phys-&gt;ks; Real&amp; radius1=geom-&gt;radius1; Real&amp; radius2=geom-&gt;radius2;
-		// FIXME? NormalShearInteraction knows nothing about whether the contact is &quot;active&quot; (force!=0) or not;
-		// former code: if(force==0) continue; /* disregard this interaction, it is not active */.
-		// It seems though that in such case either the interaction is accidentally at perfect equilibrium (unlikely)
-		// or it should have been deleted already. Right? 
-		//ANSWER : some interactions can exist without fn, e.g. distant capillary force, wich does not contribute to the overall stiffness via kn. The test is needed.
-		Real fn = (static_cast&lt;ElasticContactInteraction *&gt; (contact-&gt;interactionPhysics.get()))-&gt;normalForce.SquaredLength();
+			SpheresContactGeometry* geom=YADE_CAST&lt;SpheresContactGeometry*&gt;(contact-&gt;interactionGeometry.get()); assert(geom);
+			NormalShearInteraction* phys=YADE_CAST&lt;NormalShearInteraction*&gt;(contact-&gt;interactionPhysics.get()); assert(phys);
+			// all we need for getting stiffness
+			Vector3r&amp; normal=geom-&gt;normal; Real&amp; kn=phys-&gt;kn; Real&amp; ks=phys-&gt;ks; Real&amp; radius1=geom-&gt;radius1; Real&amp; radius2=geom-&gt;radius2;
+			// FIXME? NormalShearInteraction knows nothing about whether the contact is &quot;active&quot; (force!=0) or not;
+			// former code: if(force==0) continue; /* disregard this interaction, it is not active */.
+			// It seems though that in such case either the interaction is accidentally at perfect equilibrium (unlikely)
+			// or it should have been deleted already. Right? 
+			//ANSWER : some interactions can exist without fn, e.g. distant capillary force, wich does not contribute to the overall stiffness via kn. The test is needed.
+			Real fn = (static_cast&lt;ElasticContactInteraction *&gt; (contact-&gt;interactionPhysics.get()))-&gt;normalForce.SquaredLength();
 
-		if (fn!=0) {
+			if (fn!=0) {
 
-		//Diagonal terms of the translational stiffness matrix
-		Vector3r diag_stiffness = Vector3r(std::pow(normal.X(),2),std::pow(normal.Y(),2),std::pow(normal.Z(),2));
-		diag_stiffness *= kn-ks;
-		diag_stiffness = diag_stiffness + Vector3r(1,1,1)*ks;
+			//Diagonal terms of the translational stiffness matrix
+			Vector3r diag_stiffness = Vector3r(std::pow(normal.X(),2),std::pow(normal.Y(),2),std::pow(normal.Z(),2));
+			diag_stiffness *= kn-ks;
+			diag_stiffness = diag_stiffness + Vector3r(1,1,1)*ks;
 
-		//diagonal terms of the rotational stiffness matrix
-		// Vector3r branch1 = currentContactGeometry-&gt;normal*currentContactGeometry-&gt;radius1;
-		// Vector3r branch2 = currentContactGeometry-&gt;normal*currentContactGeometry-&gt;radius2;
-		Vector3r diag_Rstiffness =
-			Vector3r(std::pow(normal.Y(),2)+std::pow(normal.Z(),2),
-				std::pow(normal.X(),2)+std::pow(normal.Z(),2),
-				std::pow(normal.X(),2)+std::pow(normal.Y(),2));
-		diag_Rstiffness *= ks;
-		//cerr &lt;&lt; &quot;diag_Rstifness=&quot; &lt;&lt; diag_Rstiffness &lt;&lt; endl;
+			//diagonal terms of the rotational stiffness matrix
+			// Vector3r branch1 = currentContactGeometry-&gt;normal*currentContactGeometry-&gt;radius1;
+			// Vector3r branch2 = currentContactGeometry-&gt;normal*currentContactGeometry-&gt;radius2;
+			Vector3r diag_Rstiffness =
+				Vector3r(std::pow(normal.Y(),2)+std::pow(normal.Z(),2),
+					std::pow(normal.X(),2)+std::pow(normal.Z(),2),
+					std::pow(normal.X(),2)+std::pow(normal.Y(),2));
+			diag_Rstiffness *= ks;
+			//cerr &lt;&lt; &quot;diag_Rstifness=&quot; &lt;&lt; diag_Rstiffness &lt;&lt; endl;
 
-		PhysicalAction* st = ncb-&gt;physicalActions-&gt;find(contact-&gt;getId1(),actionStiffnessIndex).get();
-		GlobalStiffness* s = static_cast&lt;GlobalStiffness*&gt;(st);
-		s-&gt;stiffness += diag_stiffness;
-		s-&gt;Rstiffness += diag_Rstiffness*pow(radius1,2);	
-		st = ncb-&gt;physicalActions-&gt;find(contact-&gt;getId2(),actionStiffnessIndex).get();
-		s = static_cast&lt;GlobalStiffness*&gt;(st);
-		s-&gt;stiffness += diag_stiffness;
-		s-&gt;Rstiffness += diag_Rstiffness*pow(radius2,2);
-		
+			PhysicalAction* st = ncb-&gt;physicalActions-&gt;find(contact-&gt;getId1(),actionStiffnessIndex).get();
+			GlobalStiffness* s = static_cast&lt;GlobalStiffness*&gt;(st);
+			s-&gt;stiffness += diag_stiffness;
+			s-&gt;Rstiffness += diag_Rstiffness*pow(radius1,2);	
+			st = ncb-&gt;physicalActions-&gt;find(contact-&gt;getId2(),actionStiffnessIndex).get();
+			s = static_cast&lt;GlobalStiffness*&gt;(st);
+			s-&gt;stiffness += diag_stiffness;
+			s-&gt;Rstiffness += diag_Rstiffness*pow(radius2,2);
+			
+			}
 		}
-	}
+	#endif
 }
 
 void GlobalStiffnessCounter::action(MetaBody* ncb)

Modified: trunk/pkg/dem/Engine/StandAloneEngine/MyTetrahedronLaw.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/MyTetrahedronLaw.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/StandAloneEngine/MyTetrahedronLaw.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -73,13 +73,18 @@
 						Vector3r x			= currentContactGeometry-&gt;contactPoints[i][j];
 						Vector3r c1x			= (x - de1-&gt;se3.position);
 						Vector3r c2x			= (x - de2-&gt;se3.position);
+						#ifdef BEX_CONTAINER
+							ncb-&gt;bex.addForce (id1,-force);
+							ncb-&gt;bex.addForce (id2,+force);
+							ncb-&gt;bex.addTorque(id1,-c1x.Cross(force));
+							ncb-&gt;bex.addTorque(id2, c2x.Cross(force));
+						#else
+							static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= force;
+							static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += force;
+							static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= c1x.Cross(force);
+							static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += c2x.Cross(force);
+						#endif
 
-						// it will be some macro(	body-&gt;physicalActions,	ActionType , bodyId )
-						static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= force;
-						static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += force;
-
-						static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= c1x.Cross(force);
-						static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += c2x.Cross(force);
 					}
 				}
 

Modified: trunk/pkg/dem/Engine/StandAloneEngine/ViscousForceDamping.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/ViscousForceDamping.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/StandAloneEngine/ViscousForceDamping.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -140,12 +140,17 @@
 			Vector3r viscousDampingForce	= normalDampingForce + shearDampingForce;
 			
 //	Add forces
-			static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= viscousDampingForce;
-			static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += viscousDampingForce;
-			
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= c1x.Cross(viscousDampingForce);
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += c2x.Cross(viscousDampingForce);
-			
+			#ifdef BEX_CONTAINER
+				ncb-&gt;bex.addForce (id1,-viscousDampingForce);
+				ncb-&gt;bex.addForce (id2,+viscousDampingForce);
+				ncb-&gt;bex.addTorque(id1,-c1x.Cross(viscousDampingForce));
+				ncb-&gt;bex.addTorque(id2, c2x.Cross(viscousDampingForce));
+			#else
+				static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= viscousDampingForce;
+				static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += viscousDampingForce;
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= c1x.Cross(viscousDampingForce);
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += c2x.Cross(viscousDampingForce);
+			#endif
 			currentContactPhysics-&gt;prevNormal = currentContactGeometry-&gt;normal;
 		}
 	}

Modified: trunk/pkg/dem/Engine/StandAloneEngine/VolumicContactLaw.cpp
===================================================================
--- trunk/pkg/dem/Engine/StandAloneEngine/VolumicContactLaw.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/Engine/StandAloneEngine/VolumicContactLaw.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -479,13 +479,18 @@
 	
 			Vector3r f				= currentContactPhysics-&gt;normalForce + shearForce;
 			
-	// it will be some macro(	body-&gt;physicalActions,	ActionType , bodyId )
-			static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForceIndex).get() )-&gt;force    -= f;
-			static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForceIndex ).get() )-&gt;force    += f;
+			#ifdef BEX_CONTAINER
+				ncb-&gt;bex.addForce (id1,-f);
+				ncb-&gt;bex.addForce (id2,+f);
+				ncb-&gt;bex.addTorque(id1,-c1x.Cross(f));
+				ncb-&gt;bex.addTorque(id2, c2x.Cross(f));
+			#else
+				static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForceIndex).get() )-&gt;force    -= f;
+				static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForceIndex ).get() )-&gt;force    += f;
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentumIndex ).get() )-&gt;momentum -= c1x.Cross(f);
+				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentumIndex ).get() )-&gt;momentum += c2x.Cross(f);
+			#endif
 			
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentumIndex ).get() )-&gt;momentum -= c1x.Cross(f);
-			static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentumIndex ).get() )-&gt;momentum += c2x.Cross(f);
-			
 			currentContactPhysics-&gt;prevNormal = currentContactGeometry-&gt;normal;
 		}
 	}

Modified: trunk/pkg/dem/PreProcessor/CohesiveTriaxialTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/CohesiveTriaxialTest.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/CohesiveTriaxialTest.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -255,7 +255,6 @@
 	createActors(rootBody);
 	positionRootBody(rootBody);
 
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	shared_ptr&lt;Body&gt; body;

Modified: trunk/pkg/dem/PreProcessor/DirectShearCis.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/DirectShearCis.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/DirectShearCis.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -149,7 +149,6 @@
 // Container
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 		
 

Modified: trunk/pkg/dem/PreProcessor/Funnel.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/Funnel.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/Funnel.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -108,7 +108,6 @@
 ///////// Container
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 		
 ////////////////////////////////////

Modified: trunk/pkg/dem/PreProcessor/HydraulicTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/HydraulicTest.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/HydraulicTest.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -98,7 +98,6 @@
 ////////////////////////////////////
 
 	rootBody-&gt;transientInteractions  = shared_ptr&lt;InteractionContainer&gt; ( new InteractionVecSet );
-	rootBody-&gt;physicalActions  = shared_ptr&lt;PhysicalActionContainer&gt; ( new PhysicalActionVectorVector );
 	rootBody-&gt;bodies    = shared_ptr&lt;BodyContainer&gt; ( new BodyRedirectionVector );
 
 /////////////////////////////////////

Modified: trunk/pkg/dem/PreProcessor/MembraneTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/MembraneTest.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/MembraneTest.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -115,7 +115,6 @@
 // Containers
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 // Nodes

Modified: trunk/pkg/dem/PreProcessor/ModifiedTriaxialTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/ModifiedTriaxialTest.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/ModifiedTriaxialTest.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -261,7 +261,6 @@
 	createActors(rootBody);
 	positionRootBody(rootBody);
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionHashMap);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	shared_ptr&lt;Body&gt; body;
@@ -276,6 +275,7 @@
 	{
 		cerr &lt;&lt; &quot;sphere (&quot; &lt;&lt; it-&gt;first &lt;&lt; &quot; &quot; &lt;&lt; it-&gt;second &lt;&lt; endl;
 		createSphere(body,it-&gt;first,it-&gt;second,false,true);
+		if(want_2d) body-&gt;physicalParameters-&gt;blockedDOFs=PhysicalParameters::DOF_Z;
 		rootBody-&gt;bodies-&gt;insert(body);
 	}
 	
@@ -593,8 +593,6 @@
 	gravityCondition-&gt;gravity = gravity;
 //	shared_ptr&lt;HydraulicForceEngine&gt; hydraulicForceCondition(new HydraulicForceEngine);
 //	hydraulicForceCondition-&gt;hydraulicForce = hydraulicForce;
-  	shared_ptr&lt;MakeItFlat&gt; makeItFlat(new MakeItFlat);
-//	makeItFlatCondition-&gt;makeItFlat= makeItFlat;
 
 	shared_ptr&lt;CundallNonViscousForceDamping&gt; actionForceDamping(new CundallNonViscousForceDamping);
 	actionForceDamping-&gt;damping = dampingForce;
@@ -687,8 +685,13 @@
 	rootBody-&gt;engines.push_back(globalStiffnessTimeStepper);
 	rootBody-&gt;engines.push_back(wallStressRecorder);
 	rootBody-&gt;engines.push_back(gravityCondition);
-	if(want_2d)
-		rootBody-&gt;engines.push_back(makeItFlat);
+	// replaced by PhysicalParameters::blockedDOFs
+	#if 0
+		if(want_2d){
+	  		shared_ptr&lt;MakeItFlat&gt; makeItFlat(new MakeItFlat);
+			rootBody-&gt;engines.push_back(makeItFlat);
+		}
+	#endif
 	rootBody-&gt;engines.push_back(actionDampingDispatcher);
 	rootBody-&gt;engines.push_back(applyActionDispatcher);
 	rootBody-&gt;engines.push_back(positionIntegrator);

Modified: trunk/pkg/dem/PreProcessor/SDECImpactTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/SDECImpactTest.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/SDECImpactTest.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -194,7 +194,6 @@
 	positionRootBody(rootBody);
 
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	shared_ptr&lt;Body&gt; body;

Modified: trunk/pkg/dem/PreProcessor/SDECLinkedSpheres.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/SDECLinkedSpheres.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/SDECLinkedSpheres.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -123,7 +123,6 @@
 	
 //	rootBody-&gt;persistentInteractions	= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
 //	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 ////////////////////////////////////

Modified: trunk/pkg/dem/PreProcessor/SDECMovingWall.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/SDECMovingWall.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/SDECMovingWall.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -146,7 +146,6 @@
 ///////// Container
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 		
 ////////////////////////////////////

Modified: trunk/pkg/dem/PreProcessor/SDECSpheresPlane.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/SDECSpheresPlane.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/SDECSpheresPlane.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -117,7 +117,6 @@
 ///////// Container
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 		
 ////////////////////////////////////

Modified: trunk/pkg/dem/PreProcessor/STLImporterTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/STLImporterTest.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/STLImporterTest.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -106,7 +106,6 @@
 ///////// Container
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 		
 ////////////////////////////////////

Modified: trunk/pkg/dem/PreProcessor/SimpleShear.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/SimpleShear.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/SimpleShear.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -140,7 +140,6 @@
 // Container
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 		
 

Modified: trunk/pkg/dem/PreProcessor/TestSimpleViscoelastic.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/TestSimpleViscoelastic.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/TestSimpleViscoelastic.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -93,7 +93,6 @@
 ///////// Container
 	
     rootBody-&gt;transientInteractions	= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-    rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
     rootBody-&gt;bodies			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 ////////////////////////////////////

Modified: trunk/pkg/dem/PreProcessor/TetrahedronsTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/TetrahedronsTest.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/TetrahedronsTest.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -132,7 +132,6 @@
 ///////// Container
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 		
 ////////////////////////////////////

Modified: trunk/pkg/dem/PreProcessor/ThreePointBending.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/ThreePointBending.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/ThreePointBending.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -128,7 +128,6 @@
 ////////////////////////////////////
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	Vector3r min(10000,10000,10000),max(-10000,-10000,-10000);

Modified: trunk/pkg/dem/PreProcessor/TriaxialTest.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/TriaxialTest.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/TriaxialTest.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -253,7 +253,6 @@
 
 	//rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionHashMap);
 
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	createActors(rootBody);
@@ -399,10 +398,16 @@
 	FOREACH(const BasicSphere&amp; it, sphere_list){
 		LOG_DEBUG(&quot;sphere (&quot; &lt;&lt; it.first &lt;&lt; &quot; &quot; &lt;&lt; it.second &lt;&lt; &quot;)&quot;);
 		createSphere(body,it.first,it.second,false,true);
+		if(biaxial2dTest){ body-&gt;physicalParameters-&gt;blockedDOFs=PhysicalParameters::DOF_Z; }
 		rootBody-&gt;bodies-&gt;insert(body);
 	}	
 
-	if(defaultDt&lt;0) defaultDt=Shop::PWaveTimeStep();
+	if(defaultDt&lt;0){
+		defaultDt=Shop::PWaveTimeStep(rootBody);
+		rootBody-&gt;dt=defaultDt;
+		globalStiffnessTimeStepper-&gt;defaultDt=defaultDt;
+		LOG_INFO(&quot;Computed default (PWave) timestep &quot;&lt;&lt;defaultDt);
+	}
 
 	return true;
 }
@@ -562,7 +567,7 @@
 	//stiffnessMatrixTimeStepper-&gt;sdecGroupMask = 2;
 	//stiffnessMatrixTimeStepper-&gt;timeStepUpdateInterval = timeStepUpdateInterval;
 	
-	shared_ptr&lt;GlobalStiffnessTimeStepper&gt; globalStiffnessTimeStepper(new GlobalStiffnessTimeStepper);
+	globalStiffnessTimeStepper=shared_ptr&lt;GlobalStiffnessTimeStepper&gt;(new GlobalStiffnessTimeStepper);
 	globalStiffnessTimeStepper-&gt;sdecGroupMask = 2;
 	globalStiffnessTimeStepper-&gt;timeStepUpdateInterval = timeStepUpdateInterval;
 	globalStiffnessTimeStepper-&gt;defaultDt = defaultDt;
@@ -611,12 +616,8 @@
 		triaxialStateRecorder-&gt; interval 		= recordIntervalIter;
 		//triaxialStateRecorderer-&gt; thickness 		= thickness;
 	}
+	
 
-	shared_ptr&lt;MakeItFlat&gt; makeItFlat(new MakeItFlat);
-	makeItFlat-&gt;direction=2;
-	makeItFlat-&gt;plane_position = (lowerCorner[2]+upperCorner[2])*0.5;
-	makeItFlat-&gt;reset_force = false;	
-
 	#if 0	
 	// moving walls to regulate the stress applied
 	//cerr &lt;&lt; &quot;triaxialstressController = shared_ptr&lt;TriaxialStressController&gt; (new TriaxialStressController);&quot; &lt;&lt; std::endl;
@@ -652,7 +653,16 @@
 	
 	//if (0) rootBody-&gt;engines.push_back(shared_ptr&lt;Engine&gt;(new MicroMacroAnalyser));
 	
-	if(biaxial2dTest) rootBody-&gt;engines.push_back(makeItFlat);
+	// replaced by PhysicalParameters::blockedDOFs
+	#if 0
+		if(biaxial2dTest){
+			shared_ptr&lt;MakeItFlat&gt; makeItFlat(new MakeItFlat);
+			makeItFlat-&gt;direction=2;
+			makeItFlat-&gt;plane_position = (lowerCorner[2]+upperCorner[2])*0.5;
+			makeItFlat-&gt;reset_force = false;	
+			rootBody-&gt;engines.push_back(makeItFlat);
+		}
+	#endif
 	
 	//if(!rotationBlocked)
 	//	rootBody-&gt;engines.push_back(orientationIntegrator);

Modified: trunk/pkg/dem/PreProcessor/TriaxialTest.hpp
===================================================================
--- trunk/pkg/dem/PreProcessor/TriaxialTest.hpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/TriaxialTest.hpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -22,6 +22,7 @@
 class TriaxialStressController;
 class TriaxialCompressionEngine;
 class TriaxialStateRecorder;
+class GlobalStiffnessTimeStepper;
 
 /*! \brief Isotropic compression + triaxial compression test
 
@@ -128,6 +129,7 @@
 		shared_ptr&lt;TriaxialCompressionEngine&gt; triaxialcompressionEngine;
 		shared_ptr&lt;TriaxialStressController&gt; triaxialstressController;
 		shared_ptr&lt;TriaxialStateRecorder&gt; triaxialStateRecorder;
+		shared_ptr&lt;GlobalStiffnessTimeStepper&gt; globalStiffnessTimeStepper;
 			
 		void createBox(shared_ptr&lt;Body&gt;&amp; body, Vector3r position, Vector3r extents,bool wire);
 		void createSphere(shared_ptr&lt;Body&gt;&amp; body, Vector3r position, Real radius,bool big,bool dynamic);

Modified: trunk/pkg/dem/PreProcessor/TriaxialTestWater.cpp
===================================================================
--- trunk/pkg/dem/PreProcessor/TriaxialTestWater.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/dem/PreProcessor/TriaxialTestWater.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -276,7 +276,6 @@
 
 	//rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionHashMap);
 
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	shared_ptr&lt;Body&gt; body;

Modified: trunk/pkg/fem/Engine/StandAloneEngine/FEMLaw.cpp
===================================================================
--- trunk/pkg/fem/Engine/StandAloneEngine/FEMLaw.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/fem/Engine/StandAloneEngine/FEMLaw.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -42,7 +42,6 @@
 void FEMLaw::action(MetaBody* fem)
 {
 	shared_ptr&lt;BodyContainer&gt;&amp; bodies = fem-&gt;bodies;
-	shared_ptr&lt;PhysicalActionContainer&gt;&amp; physicalActions = fem-&gt;physicalActions;
 	
 	ublas::matrix&lt;double&gt; Ue1 , fe;
 	Ue1.resize(12,1);
@@ -76,10 +75,11 @@
 			Vector3r force = Vector3r(	  fe( i*3     , 0 )
 							, fe( i*3 + 1 , 0 )
 							, fe( i*3 + 2 , 0 ));
-			
-			static_cast&lt;Force*&gt;( physicalActions
-				-&gt;find( femTet-&gt;ids[i] , actionForce -&gt;getClassIndex() ).get() )
-					-&gt;force  += force;
+			#ifdef BEX_CONTAINER
+				fem-&gt;bex.addForce(femTet-&gt;ids[i],force);
+			#else
+				static_cast&lt;Force*&gt;( physicalActions-&gt;find( femTet-&gt;ids[i] , actionForce -&gt;getClassIndex() ).get() )-&gt;force  += force;
+			#endif
 					
 		}
 	}

Modified: trunk/pkg/fem/PreProcessor/FEMBeam.cpp
===================================================================
--- trunk/pkg/fem/PreProcessor/FEMBeam.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/fem/PreProcessor/FEMBeam.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -120,7 +120,6 @@
 	
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 	
 	

Modified: trunk/pkg/lattice/PreProcessor/LatticeExample.cpp
===================================================================
--- trunk/pkg/lattice/PreProcessor/LatticeExample.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/lattice/PreProcessor/LatticeExample.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -455,7 +455,6 @@
 	positionRootBody(rootBody);
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	

Modified: trunk/pkg/mass-spring/Engine/StandAloneEngine/MassSpringLaw.cpp
===================================================================
--- trunk/pkg/mass-spring/Engine/StandAloneEngine/MassSpringLaw.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/mass-spring/Engine/StandAloneEngine/MassSpringLaw.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -34,7 +34,6 @@
 {
 	shared_ptr&lt;BodyContainer&gt;&amp; bodies = massSpring-&gt;bodies;
 	shared_ptr&lt;InteractionContainer&gt;&amp; persistentInteractions = massSpring-&gt;persistentInteractions;
-	shared_ptr&lt;PhysicalActionContainer&gt;&amp; physicalActions = massSpring-&gt;physicalActions;
 	
 
 	InteractionContainer::iterator ii    = persistentInteractions-&gt;begin();
@@ -69,9 +68,13 @@
 			Real e  = (l-l0)/l0;
 			Real relativeVelocity = dir.Dot((p1-&gt;velocity-p2-&gt;velocity));
 			Vector3r f3 = (e*physics-&gt;stiffness + relativeVelocity* ( 1.0 - physics-&gt;damping )  )*dir;
-			
-			static_cast&lt;Force*&gt;   ( physicalActions-&gt;find( id1 , actionForce-&gt;getClassIndex() ).get() )-&gt;force    -= f3;
-			static_cast&lt;Force*&gt;   ( physicalActions-&gt;find( id2 , actionForce-&gt;getClassIndex() ).get() )-&gt;force    += f3;
+			#ifdef BEX_CONTAINER
+				massSpring-&gt;bex.addForce(id1,-f3);
+				massSpring-&gt;bex.addForce(id2, f3);
+			#else
+				static_cast&lt;Force*&gt;   ( physicalActions-&gt;find( id1 , actionForce-&gt;getClassIndex() ).get() )-&gt;force    -= f3;
+				static_cast&lt;Force*&gt;   ( physicalActions-&gt;find( id2 , actionForce-&gt;getClassIndex() ).get() )-&gt;force    += f3;
+			#endif
 		}
 	}
 	

Modified: trunk/pkg/mass-spring/PreProcessor/HangingCloth.cpp
===================================================================
--- trunk/pkg/mass-spring/PreProcessor/HangingCloth.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/mass-spring/PreProcessor/HangingCloth.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -148,7 +148,6 @@
 
 	rootBody-&gt;persistentInteractions	= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	shared_ptr&lt;PhysicalActionContainerInitializer&gt; physicalActionInitializer(new PhysicalActionContainerInitializer);

Modified: trunk/pkg/realtime-rigidbody/Engine/StandAloneEngine/FrictionLessElasticContactLaw.cpp
===================================================================
--- trunk/pkg/realtime-rigidbody/Engine/StandAloneEngine/FrictionLessElasticContactLaw.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/realtime-rigidbody/Engine/StandAloneEngine/FrictionLessElasticContactLaw.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -77,12 +77,18 @@
 				Vector3r v2 = rb2-&gt;velocity+rb2-&gt;angularVelocity.Cross(o2p);
 				Real relativeVelocity = dir.Dot(v2-v1);
 				Vector3r f = (elongation*stiffness+relativeVelocity*viscosity)/size*dir;
-	
-				static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += f;
-				static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= f;
-			
-				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += o1p.Cross(f);
-				static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= o2p.Cross(f);
+				#ifdef BEX_CONTAINER
+					ncb-&gt;bex.addForce (id1, f);
+					ncb-&gt;bex.addForce (id2,-f);
+					ncb-&gt;bex.addTorque(id1, o1p.Cross(f));
+					ncb-&gt;bex.addTorque(id2,-o2p.Cross(f));
+				#else
+					static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id1 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    += f;
+					static_cast&lt;Force*&gt;   ( ncb-&gt;physicalActions-&gt;find( id2 , actionForce   -&gt;getClassIndex() ).get() )-&gt;force    -= f;
+					static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id1 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum += o1p.Cross(f);
+					static_cast&lt;Momentum*&gt;( ncb-&gt;physicalActions-&gt;find( id2 , actionMomentum-&gt;getClassIndex() ).get() )-&gt;momentum -= o2p.Cross(f);
+				#endif
+
 			}
 		}
 	}

Modified: trunk/pkg/realtime-rigidbody/PreProcessor/BoxStack.cpp
===================================================================
--- trunk/pkg/realtime-rigidbody/PreProcessor/BoxStack.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/realtime-rigidbody/PreProcessor/BoxStack.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -95,7 +95,6 @@
 
 	rootBody-&gt;persistentInteractions	= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	shared_ptr&lt;Body&gt; body;

Modified: trunk/pkg/realtime-rigidbody/PreProcessor/RotatingBox.cpp
===================================================================
--- trunk/pkg/realtime-rigidbody/PreProcessor/RotatingBox.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/realtime-rigidbody/PreProcessor/RotatingBox.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -94,7 +94,6 @@
 	positionRootBody(rootBody);
 	
 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	

Modified: trunk/pkg/snow/PreProcessor/SnowCreepTest.cpp
===================================================================
--- trunk/pkg/snow/PreProcessor/SnowCreepTest.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/snow/PreProcessor/SnowCreepTest.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -263,7 +263,6 @@
 	positionRootBody(rootBody);
 
 // 	rootBody-&gt;transientInteractions		= shared_ptr&lt;InteractionContainer&gt;(new InteractionVecSet);
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 
 	shared_ptr&lt;Body&gt; body;

Modified: trunk/pkg/snow/PreProcessor/SnowVoxelsLoader.cpp
===================================================================
--- trunk/pkg/snow/PreProcessor/SnowVoxelsLoader.cpp	2009-03-29 01:57:12 UTC (rev 1734)
+++ trunk/pkg/snow/PreProcessor/SnowVoxelsLoader.cpp	2009-03-29 10:34:26 UTC (rev 1735)
@@ -234,7 +234,6 @@
 	createActors(rootBody);
 	positionRootBody(rootBody);
 
-	rootBody-&gt;physicalActions		= shared_ptr&lt;PhysicalActionContainer&gt;(new PhysicalActionVectorVector);
 	rootBody-&gt;bodies 			= shared_ptr&lt;BodyContainer&gt;(new BodyRedirectionVector);
 	
 	if(m_grains.size() == 0)


_______________________________________________
Mailing list: <A HREF="https://launchpad.net/~yade-dev">https://launchpad.net/~yade-dev</A>
Post to     : <A HREF="https://lists.berlios.de/mailman/listinfo/yade-dev">yade-dev at lists.launchpad.net</A>
Unsubscribe : <A HREF="https://launchpad.net/~yade-dev">https://launchpad.net/~yade-dev</A>
More help   : <A HREF="https://help.launchpad.net/ListHelp">https://help.launchpad.net/ListHelp</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000894.html">[deprecated list] [Yade-dev] [svn] r1734 - trunk/extra
</A></li>
	<LI>Next message: <A HREF="000896.html">[deprecated list] [Yade-dev] removing PhysicalAction
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#895">[ date ]</a>
              <a href="thread.html#895">[ thread ]</a>
              <a href="subject.html#895">[ subject ]</a>
              <a href="author.html#895">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/yade-dev">More information about the yade-dev
mailing list</a><br>
</body></html>

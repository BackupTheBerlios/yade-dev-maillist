<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [deprecated list] [Yade-dev] [svn] r1794 - in trunk: gui gui/py	scripts/test
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/yade-dev/2009/index.html" >
   <LINK REL="made" HREF="mailto:yade-dev%40lists.berlios.de?Subject=Re%3A%20%5Bdeprecated%20list%5D%20%5BYade-dev%5D%20%5Bsvn%5D%20r1794%20-%20in%20trunk%3A%20gui%20gui/py%0A%09scripts/test&In-Reply-To=%3C200906131509.n5DF9qQx030160%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001016.html">
   <LINK REL="Next"  HREF="001018.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[deprecated list] [Yade-dev] [svn] r1794 - in trunk: gui gui/py	scripts/test</H1>
    <B>eudoxos at BerliOS</B> 
    <A HREF="mailto:yade-dev%40lists.berlios.de?Subject=Re%3A%20%5Bdeprecated%20list%5D%20%5BYade-dev%5D%20%5Bsvn%5D%20r1794%20-%20in%20trunk%3A%20gui%20gui/py%0A%09scripts/test&In-Reply-To=%3C200906131509.n5DF9qQx030160%40sheep.berlios.de%3E"
       TITLE="[deprecated list] [Yade-dev] [svn] r1794 - in trunk: gui gui/py	scripts/test">eudoxos at mail.berlios.de
       </A><BR>
    <I>Sat Jun 13 17:09:52 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001016.html">[deprecated list] [Yade-dev] [svn] r1793 - trunk/gui/py
</A></li>
        <LI>Next message: <A HREF="001018.html">[deprecated list] [Yade-dev] [svn] r1795 - trunk/gui/py
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1017">[ date ]</a>
              <a href="thread.html#1017">[ thread ]</a>
              <a href="subject.html#1017">[ subject ]</a>
              <a href="author.html#1017">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: eudoxos
Date: 2009-06-13 17:09:51 +0200 (Sat, 13 Jun 2009)
New Revision: 1794

Added:
   trunk/gui/py/_packPredicates.cpp
   trunk/gui/py/pack.py
Modified:
   trunk/gui/SConscript
   trunk/gui/py/PythonUI.cpp
   trunk/gui/py/PythonUI_rc.py
   trunk/scripts/test/regular-sphere-pack.py
Log:
1. Move all python modules to PREFIX/lib/yadeSUFFIX/py/yade instead of */gui/yade
2. Add pack module for generating regular packings (thanks to Anton Gladky for his ideas &amp; code)
3. Add _packPredicates module for solid inclusion testing.
4. Update regular-sphere-pack.py to test new packing features.



Modified: trunk/gui/SConscript
===================================================================
--- trunk/gui/SConscript	2009-06-09 11:23:06 UTC (rev 1793)
+++ trunk/gui/SConscript	2009-06-13 15:09:51 UTC (rev 1794)
@@ -49,7 +49,7 @@
 		env.File('PythonUI_rc.py','py'),
 	])
 	if 'qt3' not in env['exclude']:
-		env.Install('$PREFIX/lib/yade$SUFFIX/gui/yade',[
+		env.Install('$PREFIX/lib/yade$SUFFIX/py/yade',[
 			env.SharedLibrary('_qt',['qt3/QtGUI-python.cpp'],SHLIBPREFIX='',LIBS=env['LIBS']+['QtGUI'],CPPPATH=env['CPPPATH']+[env['buildDir']+'/gui/qt3']), # CPPPATH is for files generated by moc which are indirectly included
 			env.File('qt.py','qt3'),
 		])
@@ -57,7 +57,7 @@
 	env.InstallAs('$PREFIX/bin/yade$SUFFIX-multi',env.File('yade-multi','py'))
 
 	# python modules are one level deeper so that you can say: from yade.wrapper import *
-	env.Install('$PREFIX/lib/yade$SUFFIX/gui/yade',[
+	env.Install('$PREFIX/lib/yade$SUFFIX/py/yade',[
 		env.SharedLibrary('wrapper',['py/yadeControl.cpp'],SHLIBPREFIX='',
 			LIBS=env['LIBS']+['XMLFormatManager','yade-factory','yade-serialization','Shop',
 				'BoundingVolumeMetaEngine',
@@ -75,6 +75,7 @@
 			),
 		env.SharedLibrary('_utils',['py/_utils.cpp'],SHLIBPREFIX='',
 			LIBS=env['LIBS']+['Shop','ConcretePM']),
+		env.SharedLibrary('_packPredicates',['py/_packPredicates.cpp'],SHLIBPREFIX=''),
 		env.SharedLibrary('_eudoxos',['py/_eudoxos.cpp'],SHLIBPREFIX='',CXXFLAGS=env['CXXFLAGS']+([] if not os.path.exists('../../brefcom-mm.hh') else ['-include','../brefcom-mm.hh']),LIBS=env['LIBS']+['Shop','ConcretePM']),
 		env.SharedLibrary('log',['py/log.cpp'],SHLIBPREFIX=''),
 		env.File('__init__.py','py'),
@@ -86,6 +87,7 @@
 		env.File('linterpolation.py','py'),
 		env.File('timing.py','py'),
 		env.File('PythonTCPServer.py','py'),
+		env.File('pack.py','py'),
 	])
 	if os.path.exists('../../brefcom-mm.hh'): Depends('py/_eudoxos.cpp','../../brefcom-mm.hh')
 

Modified: trunk/gui/py/PythonUI.cpp
===================================================================
--- trunk/gui/py/PythonUI.cpp	2009-06-09 11:23:06 UTC (rev 1793)
+++ trunk/gui/py/PythonUI.cpp	2009-06-13 15:09:51 UTC (rev 1794)
@@ -79,7 +79,7 @@
 	PyGILState_STATE pyState = PyGILState_Ensure();
 		LOG_DEBUG(&quot;Got Global Interpreter Lock, good.&quot;);
 		/* import yade (for startUI()) and yade.runtime (initially empty) namespaces */
-		PyRun_SimpleString(&quot;import sys; sys.path.insert(0,'&quot; PREFIX &quot;/lib/yade&quot; SUFFIX &quot;/gui')&quot;);
+		PyRun_SimpleString(&quot;import sys; sys.path.insert(0,'&quot; PREFIX &quot;/lib/yade&quot; SUFFIX &quot;/py')&quot;);
 		PyRun_SimpleString(&quot;import yade&quot;);
 		PyRun_SimpleString(&quot;from __future__ import division&quot;);
 

Modified: trunk/gui/py/PythonUI_rc.py
===================================================================
--- trunk/gui/py/PythonUI_rc.py	2009-06-09 11:23:06 UTC (rev 1793)
+++ trunk/gui/py/PythonUI_rc.py	2009-06-13 15:09:51 UTC (rev 1794)
@@ -122,7 +122,7 @@
 	  | | (_| | |_| |  __/ | |__| (_) | | | \__ \ (_) | |  __/
 	  |_|\__,_|____/ \___|  \____\___/|_| |_|___/\___/|_|\___|
 	&quot;&quot;&quot;,exit_msg='Bye.'
-		,rc_override={'execfile':[runtime.prefix+'/lib/yade'+runtime.suffix+'/gui/yade/ipython.py']})
+		,rc_override={'execfile':[runtime.prefix+'/lib/yade'+runtime.suffix+'/py/yade/ipython.py']})
 
 		ipshell()
 		# save history -- a workaround for atexit handlers not being run (why?)

Added: trunk/gui/py/_packPredicates.cpp
===================================================================
--- trunk/gui/py/_packPredicates.cpp	2009-06-09 11:23:06 UTC (rev 1793)
+++ trunk/gui/py/_packPredicates.cpp	2009-06-13 15:09:51 UTC (rev 1794)
@@ -0,0 +1,93 @@
+// 2009 &#169; V&#225;clav &#352;milauer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/yade-dev">eudoxos at arcig.cz</A>&gt;
+#include&lt;boost/python.hpp&gt;
+#include&lt;yade/extra/boost_python_len.hpp&gt;
+#include&lt;yade/lib-base/Logging.hpp&gt;
+#include&lt;yade/lib-base/yadeWm3.hpp&gt;
+#include&lt;Wm3Vector3.h&gt;
+
+using namespace boost;
+using namespace std;
+#ifdef LOG4CXX
+	log4cxx::LoggerPtr logger=log4cxx::Logger::getLogger(&quot;yade.predicates&quot;);
+#endif
+
+/*
+This file contains various predicates that say whether a given point is within the solid,
+or, not closer than &quot;pad&quot; to its boundary, if pad is nonzero
+Besides the (point,pad) operator, each predicate defines aabb() method that returns
+(min,max) tuple defining minimum and maximum point of axis-aligned bounding box 
+for the predicate.
+
+These classes are primarily used for yade.pack.* functions creating packings.
+See scripts/test/regular-sphere-pack.py for an example.
+
+*/
+
+// aux functions
+python::tuple vec2tuple(const Vector3r&amp; v){return boost::python::make_tuple(v[0],v[1],v[2]);}
+Vector3r tuple2vec(const python::tuple&amp; t){return Vector3r(python::extract&lt;double&gt;(t[0])(),python::extract&lt;double&gt;(t[1])(),python::extract&lt;double&gt;(t[2])());}
+void ttuple2vvec(const python::tuple&amp; t, Vector3r&amp; v1, Vector3r&amp; v2){ v1=tuple2vec(python::extract&lt;python::tuple&gt;(t[0])()); v2=tuple2vec(python::extract&lt;python::tuple&gt;(t[1])()); }
+python::tuple vvec2ttuple(const Vector3r&amp;v1, const Vector3r&amp;v2){ return python::make_tuple(vec2tuple(v1),vec2tuple(v2)); }
+
+
+/*! Sphere predicate */
+class inSphere {
+	Vector3r center; Real radius;
+public:
+	inSphere(python::tuple _center, Real _radius){center=tuple2vec(_center); radius=_radius;}
+	bool operator()(python::tuple _pt, Real pad=0.){
+		Vector3r pt=tuple2vec(_pt);
+		return ((pt-center).Length()-pad&lt;=radius-pad);
+	}
+	python::tuple aabb(){return vvec2ttuple(Vector3r(center[0]-radius,center[1]-radius,center[2]-radius),Vector3r(center[0]+radius,center[1]+radius,center[2]+radius));}
+};
+
+/* Axis-aligned box predicate */
+class inAlignedBox{
+	Vector3r mn, mx;
+public:
+	inAlignedBox(python::tuple _mn, python::tuple _mx){mn=tuple2vec(_mn); mx=tuple2vec(_mx);}
+	bool operator()(python::tuple _pt, Real pad=0.){
+		Vector3r pt=tuple2vec(_pt);
+		return
+			mn[0]+pad&lt;=pt[0] &amp;&amp; mx[0]-pad&gt;=pt[0] &amp;&amp;
+			mn[1]+pad&lt;=pt[1] &amp;&amp; mx[1]-pad&gt;=pt[1] &amp;&amp;
+			mn[2]+pad&lt;=pt[2] &amp;&amp; mx[2]-pad&gt;=pt[2];
+	}
+	python::tuple aabb(){ return vvec2ttuple(mn,mx); }
+};
+
+/* Arbitrarily oriented cylinder predicate */
+class inCylinder{
+	Vector3r c1,c2,c12; Real radius,ht;
+public:
+	inCylinder(python::tuple _c1, python::tuple _c2, Real _radius){c1=tuple2vec(_c1); c2=tuple2vec(_c2); c12=c2-c1; radius=_radius; ht=c12.Length(); }
+	bool operator()(python::tuple _pt, Real pad=0.){
+		Vector3r pt=tuple2vec(_pt);
+		Real u=(pt.Dot(c12)-c1.Dot(c12))/(ht*ht); // normalized coordinate along the c1--c2 axis
+		if((u*ht&lt;0+pad) || (u*ht&gt;ht-pad)) return false; // out of cylinder along the axis
+		Real axisDist=((pt-c1).Cross(pt-c2)).Length()/ht;
+		if(axisDist&gt;radius-pad) return false;
+		return true;
+	}
+	python::tuple aabb(){
+		// see <A HREF="http://www.gamedev.net/community/forums/topic.asp?topic_id=338522&amp;forum_id=20&amp;gforum_id=0">http://www.gamedev.net/community/forums/topic.asp?topic_id=338522&amp;forum_id=20&amp;gforum_id=0</A> for the algorithm
+		Vector3r&amp; A(c1); Vector3r&amp; B(c2); 
+		Vector3r k(
+			sqrt((pow(A[1]-B[1],2)+pow(A[2]-B[2],2)))/ht,
+			sqrt((pow(A[0]-B[0],2)+pow(A[2]-B[2],2)))/ht,
+			sqrt((pow(A[0]-B[0],2)+pow(A[1]-B[1],2)))/ht);
+		Vector3r mn(min(A[0],B[0]),min(A[1],B[1]),min(A[2],B[2])), mx(max(A[0],B[0]),max(A[1],B[1]),max(A[2],B[2]));
+		return vvec2ttuple(mn-radius*k,mx+radius*k);
+	}
+};
+
+BOOST_PYTHON_MODULE(_packPredicates){
+	boost::python::class_&lt;inSphere&gt;(&quot;inSphere&quot;,&quot;Sphere predicate.&quot;,python::init&lt;python::tuple,Real&gt;(&quot;Ctor taking center (as a 3-tuple) and radius&quot;))
+		.def(&quot;__call__&quot;,&amp;inSphere::operator(),&quot;Tell whether given point lies within this sphere, still having 'pad' space to the solid boundary&quot;).def(&quot;aabb&quot;,&amp;inSphere::aabb,&quot;Return minimum and maximum values for AABB&quot;);
+	boost::python::class_&lt;inAlignedBox&gt;(&quot;inAlignedBox&quot;,&quot;Axis-aligned box predicate&quot;,python::init&lt;python::tuple,python::tuple&gt;(&quot;Ctor taking minumum and maximum points of the box (as 3-tuples).&quot;))
+		.def(&quot;__call__&quot;,&amp;inAlignedBox::operator(),&quot;Tell whether given point lies within this box, still having 'pad' space to the solid boundary&quot;).def(&quot;aabb&quot;,&amp;inAlignedBox::aabb,&quot;Return minimum and maximum values for AABB&quot;);
+	boost::python::class_&lt;inCylinder&gt;(&quot;inCylinder&quot;,&quot;Cylinder predicate&quot;,python::init&lt;python::tuple,python::tuple,Real&gt;(&quot;Ctor taking centers of the lateral walls (as 3-tuples) and radius.&quot;))
+		.def(&quot;__call__&quot;,&amp;inCylinder::operator(),&quot;Tell whether given point lies within this cylinder, still having 'pad' space to the solid boundary&quot;).def(&quot;aabb&quot;,&amp;inCylinder::aabb,&quot;Return minimum and maximum values for AABB&quot;);
+}
+

Added: trunk/gui/py/pack.py
===================================================================
--- trunk/gui/py/pack.py	2009-06-09 11:23:06 UTC (rev 1793)
+++ trunk/gui/py/pack.py	2009-06-13 15:09:51 UTC (rev 1794)
@@ -0,0 +1,34 @@
+
+from numpy import arange; from math import sqrt
+import itertools
+from yade import utils
+
+# make predicates available from yade.pack
+from _packPredicates import *
+
+def regularOrtho(predicate,radius,gap,**kw):
+	&quot;&quot;&quot;Return set of spheres in regular orthogonal grid, clipped inside solid given by predicate.
+	Created spheres will have given radius and will be separated by gap space.&quot;&quot;&quot;
+	ret=[]
+	mn,mx=predicate.aabb()
+	xx,yy,zz=[arange(mn[i]+radius,mx[i]-radius,2*radius+gap) for i in 0,1,2]
+	for xyz in itertools.product(xx,yy,zz):
+		if predicate(xyz,radius): ret+=[utils.sphere(xyz,radius=radius,**kw)]
+	return ret
+
+def regularHexa(predicate,radius,gap,**kw):
+	&quot;&quot;&quot;Return set of spheres in regular hexagonal grid, clipped inside solid given by predicate.
+	Created spheres will have given radius and will be separated by gap space.&quot;&quot;&quot;
+	ret=[]
+	a=2*radius+gap
+	h=a*sqrt(3)/2.
+	mn,mx=predicate.aabb()
+	dim=[mx[i]-mn[i] for i in 0,1,2]
+	ii,jj,kk=[range(0,int(2*dim[0]/a)+1),range(0,int(dim[1]/h)+1),range(0,int(dim[2]/h)+1)]
+	for i,j,k in itertools.product(ii,jj,kk):
+		x,y,z=mn[0]+radius+i*a,mn[1]+radius+j*h,mn[2]+radius+k*h
+		if j%2==0: x+= a/2. if k%2==0 else -a/2.
+		if k%2!=0: x+=a/2.; y+=h/2.
+		if predicate((x,y,z),radius): ret+=[utils.sphere((x,y,z),radius=radius,**kw)]
+	return ret
+

Modified: trunk/scripts/test/regular-sphere-pack.py
===================================================================
--- trunk/scripts/test/regular-sphere-pack.py	2009-06-09 11:23:06 UTC (rev 1793)
+++ trunk/scripts/test/regular-sphere-pack.py	2009-06-13 15:09:51 UTC (rev 1794)
@@ -1,3 +1,43 @@
-O.bodies.append(utils.regularSphereOrthoPack([0,0,0],extents=[2,2,2],radius=.1,gap=.1,color=(1,0,1)))
-O.bodies.append(utils.regularSphereOrthoPack([0,0,4],extents=2,radius=.1,gap=.1,color=(0,1,0),velocity=[0,10,0]))
+from yade import pack
 
+rad,gap=.15,.02
+rho=1e3
+kw={'density':rho}
+
+O.bodies.append(
+	pack.regularHexa(pack.inSphere((0,0,4),2),radius=rad,gap=gap,color=(0,1,0),density=10*rho) # head
+	+[utils.sphere((.8,1.9,5),radius=.2,color=(.6,.6,.6),density=rho),utils.sphere((-.8,1.9,5),radius=.2,color=(.6,.6,.6),density=rho),utils.sphere((0,2.4,4),radius=.4,color=(1,0,0),density=rho)] # eyes and nose
+	+[utils.facet([(12,0,-6),(0,12,-6,),(-12,-12,-6)],dynamic=False)] # ground
+)
+
+for part in [
+	pack.regularHexa (pack.inAlignedBox((-2,-2,-2),(2,2,2)),radius=1.5*rad,gap=2*gap,color=(1,0,1),**kw), # body,
+	pack.regularOrtho(pack.inCylinder((-1,0,-2),(-1,0,-6),1),radius=rad,gap=gap,color=(0,1,1),**kw), # left leg
+	pack.regularHexa (pack.inCylinder((+1,1,-2.5),(0,3,-5),1),radius=rad,gap=gap,color=(0,1,1),**kw), # right leg
+	pack.regularHexa (pack.inCylinder((+2,0,1),(+6,0,1),1),radius=rad,gap=gap,color=(0,0,1),**kw), # right hand
+	pack.regularOrtho(pack.inCylinder((-2,0,2),(-5,0,4),1),radius=rad,gap=gap,color=(0,0,1),**kw) # left hand
+	]: O.bodies.appendClumped(part)
+
+
+
+try:
+	from yade import qt
+	qt.Controller()
+except ImportError: pass
+
+O.engines=[
+	BexResetter(),
+	BoundingVolumeMetaEngine([InteractingSphere2AABB(),InteractingFacet2AABB(),MetaInteractingGeometry2AABB()]),
+	InsertionSortCollider(),
+	InteractionDispatchers(
+		[ef2_Sphere_Sphere_Dem3DofGeom(),ef2_Facet_Sphere_Dem3DofGeom()],
+		[SimpleElasticRelationships()],
+		[ef2_Dem3Dof_Elastic_ElasticLaw()],
+	),
+	GravityEngine(gravity=(1e-2,1e-2,-1000)),
+	NewtonsDampedLaw(damping=.1)
+]
+# we don't care about physical accuracy here, over-critical step is fine as long as the simulation doesn't explode
+O.dt=2*utils.PWaveTimeStep()
+O.saveTmp('init')
+#for b in O.bodies: 


_______________________________________________
Mailing list: <A HREF="https://launchpad.net/~yade-dev">https://launchpad.net/~yade-dev</A>
Post to     : <A HREF="https://lists.berlios.de/mailman/listinfo/yade-dev">yade-dev at lists.launchpad.net</A>
Unsubscribe : <A HREF="https://launchpad.net/~yade-dev">https://launchpad.net/~yade-dev</A>
More help   : <A HREF="https://help.launchpad.net/ListHelp">https://help.launchpad.net/ListHelp</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001016.html">[deprecated list] [Yade-dev] [svn] r1793 - trunk/gui/py
</A></li>
	<LI>Next message: <A HREF="001018.html">[deprecated list] [Yade-dev] [svn] r1795 - trunk/gui/py
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1017">[ date ]</a>
              <a href="thread.html#1017">[ thread ]</a>
              <a href="subject.html#1017">[ subject ]</a>
              <a href="author.html#1017">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/yade-dev">More information about the yade-dev
mailing list</a><br>
</body></html>
